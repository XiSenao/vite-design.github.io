<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>预优化 2.0 | Vite Design</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="Vite 源码分析">
    <meta name="keywords" itemprop="keywords" content="vite 源码分析 Vue 前端开发,Vue.js,vue-cli">
    <meta property="og:title" content="vite 源码分析">
    <meta property="og:description" content="vite vue 源码分析 一个基于 Vue3 单文件组件的非打包开发服务器">
    
    <link rel="preload" href="/assets/css/0.styles.1f7fd2b8.css" as="style"><link rel="preload" href="/assets/js/app.039410b3.js" as="script"><link rel="preload" href="/assets/js/2.ada7b47c.js" as="script"><link rel="preload" href="/assets/js/13.300cdcaf.js" as="script"><link rel="prefetch" href="/assets/js/10.9e5a99ec.js"><link rel="prefetch" href="/assets/js/11.6e3574d6.js"><link rel="prefetch" href="/assets/js/12.361edb36.js"><link rel="prefetch" href="/assets/js/14.fd525acb.js"><link rel="prefetch" href="/assets/js/15.ed12af1b.js"><link rel="prefetch" href="/assets/js/16.079dff29.js"><link rel="prefetch" href="/assets/js/3.1a97a2e4.js"><link rel="prefetch" href="/assets/js/4.da0ba98d.js"><link rel="prefetch" href="/assets/js/5.de517757.js"><link rel="prefetch" href="/assets/js/6.bc690761.js"><link rel="prefetch" href="/assets/js/7.38831321.js"><link rel="prefetch" href="/assets/js/8.4a7fb891.js"><link rel="prefetch" href="/assets/js/9.82ee3f19.js">
    <link rel="stylesheet" href="/assets/css/0.styles.1f7fd2b8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Vite Design</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/guide/" class="nav-link router-link-active">
  Guide
</a></div><div class="nav-item"><a href="https://github.com/zhangyuang/vite-design" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/guide/" class="nav-link router-link-active">
  Guide
</a></div><div class="nav-item"><a href="https://github.com/zhangyuang/vite-design" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span></span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/" aria-current="page" class="sidebar-link">简介</a></li><li><a href="/guide/chinese-doc.html" class="sidebar-link">vite ⚡ 1.0 中文文档</a></li><li><a href="/guide/getting-start.html" class="sidebar-link">学习准备</a></li><li><a href="/guide/module-resolve.html" class="sidebar-link">模块解析</a></li><li><a href="/guide/optimize.html" class="sidebar-link">预优化</a></li><li><a href="/guide/render.html" class="sidebar-link">组件渲染</a></li><li><a href="/guide/hmr.html" class="sidebar-link">热替换</a></li><li><a href="/guide/2.0/optimize.html" aria-current="page" class="active sidebar-link">预优化 2.0</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/2.0/optimize.html#功能总览" class="sidebar-link">功能总览</a></li><li class="sidebar-sub-header"><a href="/guide/2.0/optimize.html#本地调试" class="sidebar-link">本地调试</a></li><li class="sidebar-sub-header"><a href="/guide/2.0/optimize.html#vite-esbuild-插件解析" class="sidebar-link">vite esbuild 插件解析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/2.0/optimize.html#entrypoints" class="sidebar-link">entryPoints</a></li><li class="sidebar-sub-header"><a href="/guide/2.0/optimize.html#bundle" class="sidebar-link">bundle</a></li><li class="sidebar-sub-header"><a href="/guide/2.0/optimize.html#external" class="sidebar-link">external</a></li><li class="sidebar-sub-header"><a href="/guide/2.0/optimize.html#format" class="sidebar-link">format</a></li><li class="sidebar-sub-header"><a href="/guide/2.0/optimize.html#outdir" class="sidebar-link">outdir</a></li><li class="sidebar-sub-header"><a href="/guide/2.0/optimize.html#plugins" class="sidebar-link">plugins</a></li><li class="sidebar-sub-header"><a href="/guide/2.0/optimize.html#特定文件-external" class="sidebar-link">特定文件 external</a></li><li class="sidebar-sub-header"><a href="/guide/2.0/optimize.html#区分入口模块和依赖模块" class="sidebar-link">区分入口模块和依赖模块</a></li><li class="sidebar-sub-header"><a href="/guide/2.0/optimize.html#dep-处理" class="sidebar-link">dep 处理</a></li></ul></li><li class="sidebar-sub-header"><a href="/guide/2.0/optimize.html#esm-工具" class="sidebar-link">esm 工具</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/2.0/optimize.html#使用方式" class="sidebar-link">使用方式</a></li></ul></li><li class="sidebar-sub-header"><a href="/guide/2.0/optimize.html#ssr-框架" class="sidebar-link">SSR 框架</a></li></ul></li><li><a href="/guide/2.0/ssr.html" class="sidebar-link">SSR + Vite</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="预优化-2-0"><a href="#预优化-2-0" class="header-anchor">#</a> 预优化 2.0</h1> <p>本篇章将讲述 Vite2.0 版本在预优化(Pre-Bundling)过程中所做的一些工作。</p> <h2 id="功能总览"><a href="#功能总览" class="header-anchor">#</a> 功能总览</h2> <p>Vite2.0 虽然底层代码跟 1.0 比改动很大，但总体理念和使用方式目前看起来差别不大。</p> <p>Vite2.0 在底层代码的改动较大的地方大概是使用了 http + <a href="https://github.com/senchalabs/connect" target="_blank" rel="noopener noreferrer">connect<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 模块来代替 1.0 中的直接使用 koa 框架的一些能力。并且预优化的工具也由 rollup 的 <a href="https://github.com/rollup/plugins/tree/master/packages/commonjs" target="_blank" rel="noopener noreferrer">commonjs 插件<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>替换为 <a href="https://esbuild.github.io/api/" target="_blank" rel="noopener noreferrer">esbuild<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。<br>
在 1.0 的使用过程中我就发现了一些 rollup 的 commonjs 插件的一些 <a href="https://github.com/rollup/plugins/issues/556" target="_blank" rel="noopener noreferrer">bug<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，并且提了一些 issue 记录，但是后续由于忙着开发自己的 <a href="https://github.com/ykfe/ssr" target="_blank" rel="noopener noreferrer">SSR 框架<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>去了, 就没怎么跟进后续的进展。现在看到 2.0 换成了 esbuild，不仅构建速度大大提升，相应的 bug 也少了不少。<br>
在正式阅读源码前，本来以为 Vite 只是做了模块格式 <code>format:esm</code> 的简单操作，但是仔细阅读之后发现 Vite 做的工作还是不少的。这里大力推荐大家阅读一下 Vite2.0 的代码无论是仓库规范还是具体编码都是非常优秀值得大家学习的，且体量不大易于调试，比 Webpack 这些巨无霸级别的工具估计连作者自己都没办法掌握所有代码的要好得多。</p> <h2 id="本地调试"><a href="#本地调试" class="header-anchor">#</a> 本地调试</h2> <p>调试方式与 1.0 大体没有变化，只是 2.0 的架构变成了 monorepo 的形式，当然我们不需要管其他的 package，只需要调试 Vite 即可。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">git</span> clone git@github.com:vitejs/vite.git
$ <span class="token builtin class-name">cd</span> vite <span class="token operator">&amp;&amp;</span> <span class="token function">yarn</span>
$ <span class="token builtin class-name">cd</span> packages/vite <span class="token operator">&amp;&amp;</span> <span class="token function">yarn</span> build <span class="token operator">&amp;&amp;</span> <span class="token function">yarn</span> <span class="token function">link</span>
$ <span class="token function">yarn</span> dev
</code></pre></div><p>然后再通过 Vite 脚手架创建一个最简单的 example 来 link Vite</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">npm</span> init @vitejs/app my-vue-app <span class="token parameter variable">--template</span> vue
$ <span class="token builtin class-name">cd</span> my-vue-app <span class="token operator">&amp;&amp;</span> <span class="token function">yarn</span> <span class="token operator">&amp;&amp;</span> <span class="token function">yarn</span> <span class="token function">link</span> vite
$ npx vite optimize <span class="token parameter variable">--force</span>
</code></pre></div><p>然后就可以开始愉快的调试源码了</p> <h2 id="vite-esbuild-插件解析"><a href="#vite-esbuild-插件解析" class="header-anchor">#</a> vite esbuild 插件解析</h2> <p>这里我们舍去对本章内容不重要的 Vite resolve 模块的逻辑，只看 Vite 到底用 esbuild 干了什么<br>
我们直接找到最精华的一段代码</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// vite/src/node/optimizer/index.ts</span>

<span class="token keyword">const</span> esbuildService <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">ensureService</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">await</span> esbuildService<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  entryPoints<span class="token operator">:</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>flatIdDeps<span class="token punctuation">)</span><span class="token punctuation">,</span>
  bundle<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  format<span class="token operator">:</span> <span class="token string">'esm'</span><span class="token punctuation">,</span>
  external<span class="token operator">:</span> config<span class="token punctuation">.</span>optimizeDeps<span class="token operator">?.</span>exclude<span class="token punctuation">,</span>
  logLevel<span class="token operator">:</span> <span class="token string">'error'</span><span class="token punctuation">,</span>
  splitting<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  sourcemap<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  outdir<span class="token operator">:</span> cacheDir<span class="token punctuation">,</span>
  treeShaking<span class="token operator">:</span> <span class="token string">'ignore-annotations'</span><span class="token punctuation">,</span>
  metafile<span class="token operator">:</span> esbuildMetaPath<span class="token punctuation">,</span>
  define<span class="token punctuation">,</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">esbuildDepPlugin</span><span class="token punctuation">(</span>flatIdDeps<span class="token punctuation">,</span> flatIdToExports<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>这里就是最终的 Vite 调用 esbuild api 的地方，让我们来一一分析它到底干了啥。</p> <h3 id="entrypoints"><a href="#entrypoints" class="header-anchor">#</a> entryPoints</h3> <p>首先是 <code>entryPoints</code> 就是打包的入口，这里我们先不用管 Vite 到底是怎么去收集模块依赖的。我们后续章节会分析。只需要知道默认的 example 中 <code>flatIdDeps</code> 大概长下面这样。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token literal-property property">vue</span><span class="token operator">:</span> <span class="token string">'/Users/yuuang/Desktop/my-vue-app/node_modules/vue/dist/vue.runtime.esm-bundler.js'</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Vite 将会根据 <code>module</code>, <code>jsnext:main</code>, <code>jsnext</code> 这样的字段顺序来查找最终解析的文件的绝对路径。比如 Vue 的 module 字段指向 <code>dist/vue.runtime.esm-bundler.js</code>, 所以最终的到的对象就是上述所示。<br>
这里取的是 Object.keys 也就是 <code>entryPoints: ['vue']</code> 的形式，当你的应用还依赖其他模块时，就会是一个模块依赖数组例如 <code>entryPoints: ['vue', 'vue-router']</code>。</p> <h3 id="bundle"><a href="#bundle" class="header-anchor">#</a> bundle</h3> <p>bundle: true 就是将模块的依赖与模块自身打包成一个文件。这里对标的是 Webpack 的 bundle 功能而不是 tsc， babel 这种将原模块与 convert 之后的模块文件一一对应的这种工具。</p> <h3 id="external"><a href="#external" class="header-anchor">#</a> external</h3> <p>依赖外置，不需要处理的模块。这个选项在做服务端渲染或者应用体积优化的时候经常用到。举个例子当开启了这个选项并做了一些配置时。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> React <span class="token keyword">from</span> <span class="token string">'react'</span>
</code></pre></div><p>打包后的代码仍然保留这段代码，而不是将 react 的代码打包进来。</p> <h3 id="format"><a href="#format" class="header-anchor">#</a> format</h3> <p>输出模块格式为 esm，这个没什么好说的</p> <h3 id="outdir"><a href="#outdir" class="header-anchor">#</a> outdir</h3> <p>预优化的缓存文件夹，默认为 <code>node_modules/.vite</code></p> <h3 id="plugins"><a href="#plugins" class="header-anchor">#</a> plugins</h3> <p><code>esbuildDepPlugin</code> 这个插件就是 Vite 在 esbuild 打包中最核心的逻辑了。让我们来看看他到底干了什么事情。<br>
在分析这个插件的源码之前，我们先看 esbuild 官方给的一个最简单的插件例子，来看看如何编写 esbuild 的插件，了解一个最基本的工作流程。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> envPlugin <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'env'</span><span class="token punctuation">,</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token parameter">build</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    build<span class="token punctuation">.</span><span class="token function">onResolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">filter</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^env$</span><span class="token regex-delimiter">/</span></span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">args</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">path</span><span class="token operator">:</span> args<span class="token punctuation">.</span>path<span class="token punctuation">,</span>
      <span class="token literal-property property">namespace</span><span class="token operator">:</span> <span class="token string">'env-ns'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    build<span class="token punctuation">.</span><span class="token function">onLoad</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">filter</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">.*</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token literal-property property">namespace</span><span class="token operator">:</span> <span class="token string">'env-ns'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">contents</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">'json'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'esbuild'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">entryPoints</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'app.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">bundle</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">outfile</span><span class="token operator">:</span> <span class="token string">'out.js'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>envPlugin<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>这里我们编写了一个名字为 env 的插件。它干了什么事情呢，比如我们有下面的这一段源代码</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">PATH</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'env'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">PATH is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">PATH</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
</code></pre></div><p><code>esbuild</code> 在 <code>onResolve</code> 阶段通过正则匹配到了 <code>env</code> 这个我们想 <code>import</code> 的模块，并且把它交给了一个名称为 <code>env-ns</code> 的流程做最终的处理。在 <code>env-ns</code> 中，我们将当前的 <code>process.env</code> 环境变量 <code>stringify</code> 成 <code>json</code> 字符串的形式返回给了 <code>contents</code>。也就是 <code>env</code> 这个模块，最终返回的就是 <code>process.env</code> 的值</p> <p>ok,了解完 esbuild 插件的一个基本的规范之后，我们再来看 <code>esbuildDepPlugin</code> 的内容。<br>
同样我们摒除暂时不需要关系的模块 resolve 逻辑，只看核心逻辑</p> <h3 id="特定文件-external"><a href="#特定文件-external" class="header-anchor">#</a> 特定文件 external</h3> <p>第一个处理是对特定格式文件的 external 处理，因为这些文件 esbuild 要么无法处理要么不应该由它来处理，Vite 自身会有另外的专门针对这些类型文件的处理逻辑。</p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">const</span> externalTypes <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">'css'</span><span class="token punctuation">,</span>
  <span class="token comment">// supported pre-processor types</span>
  <span class="token string">'less'</span><span class="token punctuation">,</span>
  <span class="token string">'sass'</span><span class="token punctuation">,</span>
  <span class="token string">'scss'</span><span class="token punctuation">,</span>
  <span class="token string">'styl'</span><span class="token punctuation">,</span>
  <span class="token string">'stylus'</span><span class="token punctuation">,</span>
  <span class="token string">'postcss'</span><span class="token punctuation">,</span>
  <span class="token comment">// known SFC types</span>
  <span class="token string">'vue'</span><span class="token punctuation">,</span>
  <span class="token string">'svelte'</span><span class="token punctuation">,</span>
  <span class="token comment">// JSX/TSX may be configured to be compiled differently from how esbuild</span>
  <span class="token comment">// handles it by default, so exclude them as well</span>
  <span class="token string">'jsx'</span><span class="token punctuation">,</span>
  <span class="token string">'tsx'</span><span class="token punctuation">,</span>
  <span class="token operator">...</span><span class="token constant">KNOWN_ASSET_TYPES</span>
<span class="token punctuation">]</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">KNOWN_ASSET_TYPES</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token comment">// images</span>
  <span class="token string">'png'</span><span class="token punctuation">,</span>
  <span class="token string">'jpe?g'</span><span class="token punctuation">,</span>
  <span class="token string">'gif'</span><span class="token punctuation">,</span>
  <span class="token string">'svg'</span><span class="token punctuation">,</span>
  <span class="token string">'ico'</span><span class="token punctuation">,</span>
  <span class="token string">'webp'</span><span class="token punctuation">,</span>
  <span class="token string">'avif'</span><span class="token punctuation">,</span>

  <span class="token comment">// media</span>
  <span class="token string">'mp4'</span><span class="token punctuation">,</span>
  <span class="token string">'webm'</span><span class="token punctuation">,</span>
  <span class="token string">'ogg'</span><span class="token punctuation">,</span>
  <span class="token string">'mp3'</span><span class="token punctuation">,</span>
  <span class="token string">'wav'</span><span class="token punctuation">,</span>
  <span class="token string">'flac'</span><span class="token punctuation">,</span>
  <span class="token string">'aac'</span><span class="token punctuation">,</span>

  <span class="token comment">// fonts</span>
  <span class="token string">'woff2?'</span><span class="token punctuation">,</span>
  <span class="token string">'eot'</span><span class="token punctuation">,</span>
  <span class="token string">'ttf'</span><span class="token punctuation">,</span>
  <span class="token string">'otf'</span><span class="token punctuation">,</span>

  <span class="token comment">// other</span>
  <span class="token string">'wasm'</span>
<span class="token punctuation">]</span>
 build<span class="token punctuation">.</span><span class="token function">onResolve</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">filter</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\\.(</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span> externalTypes<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">)(\\?.*)?$</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> <span class="token literal-property property">path</span><span class="token operator">:</span> id<span class="token punctuation">,</span> importer<span class="token punctuation">,</span> kind <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> resolved <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">resolve</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> importer<span class="token punctuation">,</span> kind<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>resolved<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">path</span><span class="token operator">:</span> resolved<span class="token punctuation">,</span>
        <span class="token literal-property property">external</span><span class="token operator">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre></div><h3 id="区分入口模块和依赖模块"><a href="#区分入口模块和依赖模块" class="header-anchor">#</a> 区分入口模块和依赖模块</h3> <p>Vite 对入口模块和依赖模块使用了不同的处理规则，入口模块指的是我们直接 import 的模块或者通过 include 制定的模块。而依赖模块则是入口模块自身的依赖也就是 dependencies
这里可以看到如果是入口模块，我们则交给 <code>name</code> 为 <code>dep</code> 的流程去继续处理，且我们只返回一个 bare name，裸的模块名。比如 <code>vue</code>, <code>vue-router</code> 原始的名称。而非入口模块，我们则直接返回一个模块入口文件的绝对路径。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">resolveEntry</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">id</span><span class="token operator">:</span> string<span class="token punctuation">,</span> <span class="token literal-property property">isEntry</span><span class="token operator">:</span> boolean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> flatId <span class="token operator">=</span> <span class="token function">flattenId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>flatId <span class="token keyword">in</span> qualified<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> isEntry
      <span class="token operator">?</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">path</span><span class="token operator">:</span> flatId<span class="token punctuation">,</span>
          <span class="token literal-property property">namespace</span><span class="token operator">:</span> <span class="token string">'dep'</span>
        <span class="token punctuation">}</span>
      <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">path</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>qualified<span class="token punctuation">[</span>flatId<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

build<span class="token punctuation">.</span><span class="token function">onResolve</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span> <span class="token literal-property property">filter</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^[\w@][^:]</span><span class="token regex-delimiter">/</span></span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> <span class="token literal-property property">path</span><span class="token operator">:</span> id<span class="token punctuation">,</span> importer<span class="token punctuation">,</span> kind <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> isEntry <span class="token operator">=</span> <span class="token operator">!</span>importer
    <span class="token comment">// ensure esbuild uses our resolved entires</span>
    <span class="token keyword">let</span> entry
    <span class="token comment">// if this is an entry, return entry namespace resolve result</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>entry <span class="token operator">=</span> <span class="token function">resolveEntry</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> isEntry<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> entry
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre></div><h3 id="dep-处理"><a href="#dep-处理" class="header-anchor">#</a> dep 处理</h3> <p>这块的工作基本上是预优化的核心内容。这里 Vite 只干了一件事情，就是生成了一个代理模块来导出原模块的原始 id。
举个例子，上面我们提到了 Vite 会把入口模块交给 namespace 为 <code>dep</code> 的流程去做进一步的处理。且只传递给了一个最原始的 Bare id。
Vite 在这里用 esbuild 提供的 parse 词法分析逻辑来分析入口模块的 import, export 信息
当入口模块即没有 <code>import</code> 关键字 也没有 <code>export</code> 关键字时，我们认为它是一个 cjs 模块。生成的代理模块的格式如下</p> <div class="language-js extra-class"><pre class="language-js"><code>contents <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">export default require(&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>relativePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;);</span><span class="token template-punctuation string">`</span></span>
</code></pre></div><p>当入口模块使用 <code>export default</code> 进行导出时，我们生成的代理模块的格式如下</p> <div class="language-js extra-class"><pre class="language-js"><code>contents <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">import d from &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>relativePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;;export default d;</span><span class="token template-punctuation string">`</span></span>
</code></pre></div><p>当入口模块存在 <code>ReExports</code> 时，比如 <code>export * from './xxx.js'</code> 或者 <code>export</code> 关键字出现的次数大于1，或者不存在 <code>export default</code>的时候生成的代理模块的格式如下
这也是大多数符合标准的模块最终处理完成的格式。</p> <div class="language-js extra-class"><pre class="language-js"><code>contents <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\nexport * from &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>relativePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span>
</code></pre></div><p>以 Vue 为例，当我们处理完之后。执行 <code>import Vue from 'vue'</code> 时，<code>'vue'</code> 实际返回的 contents 是 <code>export * from &quot;./node_modules/vue/dist/vue.runtime.esm-bundler.js&quot;</code></p> <p>通过注释，我们可以看出这样做的目的有两个</p> <ul><li>使 esbuild 最终输出符合期望的结构</li> <li>如果不分离代理模块和真实模块，esbuild 可能会重复打包相同模块</li></ul> <p>对于第一个原因，我自己调试的时候测试了一下，如果不交给 dep 去处理，生成的最终格式是什么样的。</p> <ul><li>当我们使用 dep 时，生成的最终文件在 cache 目录是 <code>node_modules/vite/vue.js</code></li> <li>不使用 dep 时，生成的最终文件在 cache 目录是 <code>node_modules/vite/vue.runtime.esm-bundler.js</code>，此时应用会提示找不到 Vue 文件。</li></ul> <p>且当我们入口模块超过一个时，例如存在 <code>['vue', 'vue-router']</code> 的时候，不使用 dep 的话将会生成带有文件夹的结构。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ tree node_modules/.vite
node_modules/.vite
├── _esbuild.json
├── _metadata.json
├── vue
│   └── dist
│       └── vue.runtime.esm-bundler.js
└── vue-router
    └── dist
        └── vue-router.esm.js
</code></pre></div><p>于是我猜想 Vite 这么干是为了方便上层统一处理，否则生成文件名称文件结构都是不一定的会增加处理的难度。<br>
对于第二个原因，按照注释所说是因为真实的模块可能会通过相对引用的方式被导入会造成重复打包，我尝试了几种测试用例没能够复现，可能是对这块具体意思的理解不准确。希望看到这篇文章的人有兴趣可以去分析一下并且提交 PR 来更新本文档。</p> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token comment">// For entry files, we'll read it ourselves and construct a proxy module</span>
<span class="token comment">// to retain the entry's raw id instead of file path so that esbuild</span>
<span class="token comment">// outputs desired output file structure.</span>
<span class="token comment">// It is necessary to do the re-exporting to separate the virtual proxy</span>
<span class="token comment">// module from the actual module since the actual module may get</span>
<span class="token comment">// referenced via relative imports - if we don't separate the proxy and</span>
<span class="token comment">// the actual module, esbuild will create duplicated copies of the same</span>
<span class="token comment">// module!</span>
<span class="token keyword">const</span> root <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>root<span class="token punctuation">)</span>
build<span class="token punctuation">.</span><span class="token function">onLoad</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">filter</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">.*</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token literal-property property">namespace</span><span class="token operator">:</span> <span class="token string">'dep'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> <span class="token literal-property property">path</span><span class="token operator">:</span> id <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> entryFile <span class="token operator">=</span> qualified<span class="token punctuation">[</span>id<span class="token punctuation">]</span>
  <span class="token keyword">let</span> relativePath <span class="token operator">=</span> <span class="token function">normalizePath</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">relative</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> entryFile<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>relativePath<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    relativePath <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>relativePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> contents <span class="token operator">=</span> <span class="token string">''</span>
  <span class="token keyword">const</span> data <span class="token operator">=</span> exportsData<span class="token punctuation">[</span>id<span class="token punctuation">]</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>imports<span class="token punctuation">,</span> exports<span class="token punctuation">]</span> <span class="token operator">=</span> data
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>imports<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>exports<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// cjs</span>
    contents <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">export default require(&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>relativePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;);</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>exports<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'default'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      contents <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">import d from &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>relativePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;;export default d;</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      data<span class="token punctuation">.</span>hasReExports <span class="token operator">||</span>
      exports<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">||</span>
      exports<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">'default'</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      contents <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\nexport * from &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>relativePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> ext <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>entryFile<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ext <span class="token operator">===</span> <span class="token string">'mjs'</span><span class="token punctuation">)</span> ext <span class="token operator">=</span> <span class="token string">'js'</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">loader</span><span class="token operator">:</span> ext <span class="token keyword">as</span> Loader<span class="token punctuation">,</span>
    contents<span class="token punctuation">,</span>
    <span class="token literal-property property">resolveDir</span><span class="token operator">:</span> root
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="esm-工具"><a href="#esm-工具" class="header-anchor">#</a> esm 工具</h2> <p>上面分析完了 Vite2.0 的 optimize逻辑<br>
由于我们小组打算做一个基于 esm 的类似于 <a href="https://codesandbox.io/" target="_blank" rel="noopener noreferrer">codesandbox<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的应用，在模块处理的过程中我们希望使用 Vite 的成熟能力，所以这里我把 Vite 的 optimize 功能简单的拆分了一下写了一个 <a href="https://www.npmjs.com/package/esm-optimize" target="_blank" rel="noopener noreferrer">esm-optimize<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>模块。做到项目无关，同时不需要创建 vite.config 配置文件。根据入参找到具体的模块进行更新，方便上层业务根据实际情况决定要如何使用 optimize 能力。</p> <h3 id="使用方式"><a href="#使用方式" class="header-anchor">#</a> 使用方式</h3> <p>我们提供 cli 的形式或者模块的形式直接导入使用</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">npm</span> i <span class="token parameter variable">-g</span> esm-optimize
$ esm react vue <span class="token comment"># 优化 react vue 模块</span>
$ esm react vue <span class="token parameter variable">--force</span> <span class="token comment"># 删除 cache 目录 强制重新 optimize</span>
$ esm react vue <span class="token parameter variable">--config</span> <span class="token comment"># 显示最终生成的 config</span>
</code></pre></div><p>以模块的形式使用</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> optimize <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'esm-optimize'</span>

<span class="token keyword">await</span> <span class="token function">optimize</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">root</span><span class="token operator">:</span> string<span class="token punctuation">,</span> <span class="token comment">// 默认为 cwd </span>
  <span class="token literal-property property">optimizeCacheDir</span><span class="token operator">:</span> string<span class="token punctuation">,</span> <span class="token comment">// 默认的 vite 缓存文件夹为 `node_modules/.vite`</span>
  <span class="token literal-property property">optimizeDeps</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 要处理的 模块</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">force</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token comment">// 强制优化</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="ssr-框架"><a href="#ssr-框架" class="header-anchor">#</a> SSR 框架</h2> <p>最后在这里推荐一下我写的 <a href="https://github.com/ykfe/ssr" target="_blank" rel="noopener noreferrer">SSR框架<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 在最新的 v5.0 版本中，同时支持 React 和 Vue 的服务端渲染框架，且提供一键以 Serverless 的形式发布上云的功能。我们可以非常有自信说它是地球上最先进的ssr框架。并且会在最近集成 Vue3 + Vite + SSR 的最佳实践。欢迎关注使用。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/guide/hmr.html" class="prev">
        热替换
      </a></span> <span class="next"><a href="/guide/2.0/ssr.html">
        SSR + Vite
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.039410b3.js" defer></script><script src="/assets/js/2.ada7b47c.js" defer></script><script src="/assets/js/13.300cdcaf.js" defer></script>
  </body>
</html>
