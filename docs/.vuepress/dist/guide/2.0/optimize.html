<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>预优化 2.0 | Vite Design</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="Vite 源码分析">
    <meta name="keywords" itemprop="keywords" content="vite 源码分析, rollup 打包流程">
    <meta property="og:title" content="vite 源码分析">
    <meta property="og:description" content="vite vue 源码分析 一个基于 Vue3 单文件组件的非打包开发服务器">
    
    <link rel="preload" href="/assets/css/0.styles.1f7fd2b8.css" as="style"><link rel="preload" href="/assets/js/app.0fb2595b.js" as="script"><link rel="preload" href="/assets/js/2.52a120d4.js" as="script"><link rel="preload" href="/assets/js/10.e4898816.js" as="script"><link rel="prefetch" href="/assets/js/11.1e014dea.js"><link rel="prefetch" href="/assets/js/12.d913702a.js"><link rel="prefetch" href="/assets/js/13.61dc25e8.js"><link rel="prefetch" href="/assets/js/14.b06b28d3.js"><link rel="prefetch" href="/assets/js/15.ed12af1b.js"><link rel="prefetch" href="/assets/js/16.cf2608a6.js"><link rel="prefetch" href="/assets/js/3.ebe90f04.js"><link rel="prefetch" href="/assets/js/4.f01d629c.js"><link rel="prefetch" href="/assets/js/5.a97d1a95.js"><link rel="prefetch" href="/assets/js/6.cd780319.js"><link rel="prefetch" href="/assets/js/7.ef160239.js"><link rel="prefetch" href="/assets/js/8.051c9bd3.js"><link rel="prefetch" href="/assets/js/9.ed1c8010.js">
    <link rel="stylesheet" href="/assets/css/0.styles.1f7fd2b8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Vite Design</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/guide/" class="nav-link router-link-active">
  Guide
</a></div><div class="nav-item"><a href="https://github.com/FinalAshen/vite-design.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/guide/" class="nav-link router-link-active">
  Guide
</a></div><div class="nav-item"><a href="https://github.com/FinalAshen/vite-design.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span></span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/chinese-doc.html" class="sidebar-link">vite ⚡ 1.0 中文文档</a></li><li><a href="/guide/getting-start.html" class="sidebar-link">学习准备</a></li><li><a href="/guide/module-resolve.html" class="sidebar-link">模块解析</a></li><li><a href="/guide/optimize.html" class="sidebar-link">预优化</a></li><li><a href="/guide/render.html" class="sidebar-link">组件渲染</a></li><li><a href="/guide/hmr.html" class="sidebar-link">热替换</a></li><li><a href="/guide/2.0/optimize.html" aria-current="page" class="active sidebar-link">预优化 2.0</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/2.0/optimize.html#功能总览" class="sidebar-link">功能总览</a></li><li class="sidebar-sub-header"><a href="/guide/2.0/optimize.html#本地调试" class="sidebar-link">本地调试</a></li><li class="sidebar-sub-header"><a href="/guide/2.0/optimize.html#vite-esbuild-插件解析" class="sidebar-link">vite esbuild 插件解析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/2.0/optimize.html#entrypoints" class="sidebar-link">entryPoints</a></li><li class="sidebar-sub-header"><a href="/guide/2.0/optimize.html#bundle" class="sidebar-link">bundle</a></li><li class="sidebar-sub-header"><a href="/guide/2.0/optimize.html#external" class="sidebar-link">external</a></li><li class="sidebar-sub-header"><a href="/guide/2.0/optimize.html#format" class="sidebar-link">format</a></li><li class="sidebar-sub-header"><a href="/guide/2.0/optimize.html#outdir" class="sidebar-link">outdir</a></li><li class="sidebar-sub-header"><a href="/guide/2.0/optimize.html#plugins" class="sidebar-link">plugins</a></li><li class="sidebar-sub-header"><a href="/guide/2.0/optimize.html#esbuilddepplugin" class="sidebar-link">esbuildDepPlugin</a></li></ul></li></ul></li><li><a href="/guide/2.0/ssr.html" class="sidebar-link">SSR + Vite</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="预优化-2-0"><a href="#预优化-2-0" class="header-anchor">#</a> 预优化 2.0</h1> <p>本篇章将讲述 Vite2.0 版本在预优化(Pre-Bundling)过程中所做的一些工作。</p> <h2 id="功能总览"><a href="#功能总览" class="header-anchor">#</a> 功能总览</h2> <p>Vite2.0 虽然底层代码跟 1.0 比改动很大，但总体理念和使用方式目前看起来差别不大。</p> <p>Vite2.0 在底层代码的改动较大的地方大概是使用了 http + <a href="https://github.com/senchalabs/connect" target="_blank" rel="noopener noreferrer">connect<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 模块来代替 1.0 中的直接使用 koa 框架的一些能力。并且预优化的工具也由 rollup 的 <a href="https://github.com/rollup/plugins/tree/master/packages/commonjs" target="_blank" rel="noopener noreferrer">commonjs 插件<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>替换为 <a href="https://esbuild.github.io/api/" target="_blank" rel="noopener noreferrer">esbuild<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。<br>
在 1.0 的使用过程中我就发现了一些 rollup 的 commonjs 插件的一些 <a href="https://github.com/rollup/plugins/issues/556" target="_blank" rel="noopener noreferrer">bug<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，并且提了一些 issue 记录，但是后续由于忙着开发自己的 <a href="https://github.com/ykfe/ssr" target="_blank" rel="noopener noreferrer">SSR 框架<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>去了, 就没怎么跟进后续的进展。现在看到 2.0 换成了 esbuild，不仅构建速度大大提升，相应的 bug 也少了不少。<br>
在正式阅读源码前，本来以为 Vite 只是做了模块格式 <code>format:esm</code> 的简单操作，但是仔细阅读之后发现 Vite 做的工作还是不少的。这里大力推荐大家阅读一下 Vite2.0 的代码无论是仓库规范还是具体编码都是非常优秀值得大家学习的，且体量不大易于调试，比 Webpack 这些巨无霸级别的工具估计连作者自己都没办法掌握所有代码的要好得多。</p> <h2 id="本地调试"><a href="#本地调试" class="header-anchor">#</a> 本地调试</h2> <p>调试方式与 1.0 大体没有变化，只是 2.0 的架构变成了 monorepo 的形式，当然我们不需要管其他的 package，只需要调试 Vite 即可。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">git</span> clone git@github.com:vitejs/vite.git
$ <span class="token builtin class-name">cd</span> vite <span class="token operator">&amp;&amp;</span> <span class="token function">yarn</span>
$ <span class="token builtin class-name">cd</span> packages/vite <span class="token operator">&amp;&amp;</span> <span class="token function">yarn</span> build <span class="token operator">&amp;&amp;</span> <span class="token function">yarn</span> <span class="token function">link</span>
$ <span class="token function">yarn</span> dev
</code></pre></div><p>然后再通过 Vite 脚手架创建一个最简单的 example 来 link Vite</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">npm</span> init @vitejs/app my-vue-app <span class="token parameter variable">--template</span> vue
$ <span class="token builtin class-name">cd</span> my-vue-app <span class="token operator">&amp;&amp;</span> <span class="token function">yarn</span> <span class="token operator">&amp;&amp;</span> <span class="token function">yarn</span> <span class="token function">link</span> vite
$ npx vite optimize <span class="token parameter variable">--force</span>
</code></pre></div><p>然后就可以开始愉快的调试源码了</p> <h2 id="vite-esbuild-插件解析"><a href="#vite-esbuild-插件解析" class="header-anchor">#</a> vite esbuild 插件解析</h2> <p>这里我们舍去对本章内容不重要的 Vite resolve 模块的逻辑，只看 Vite 到底用 esbuild 干了什么<br>
我们直接找到最精华的一段代码</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// vite/src/node/optimizer/index.ts</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> plugins <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">...</span>esbuildOptions <span class="token punctuation">}</span> <span class="token operator">=</span> config<span class="token punctuation">.</span>optimizeDeps<span class="token operator">?.</span>esbuildOptions <span class="token operator">??</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  absWorkingDir<span class="token operator">:</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  entryPoints<span class="token operator">:</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>flatIdDeps<span class="token punctuation">)</span><span class="token punctuation">,</span>
  bundle<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token comment">// We can't use platform 'neutral', as esbuild has custom handling</span>
  <span class="token comment">// when the platform is 'node' or 'browser' that can't be emulated</span>
  <span class="token comment">// by using mainFields and conditions</span>
  platform<span class="token operator">:</span>
    config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>ssr <span class="token operator">&amp;&amp;</span> config<span class="token punctuation">.</span>ssr<span class="token operator">?.</span>target <span class="token operator">!==</span> <span class="token string">'webworker'</span>
      <span class="token operator">?</span> <span class="token string">'node'</span>
      <span class="token operator">:</span> <span class="token string">'browser'</span><span class="token punctuation">,</span>
  define<span class="token punctuation">,</span>
  format<span class="token operator">:</span> <span class="token string">'esm'</span><span class="token punctuation">,</span>
  target<span class="token operator">:</span> isBuild <span class="token operator">?</span> config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>target <span class="token operator">||</span> <span class="token keyword">undefined</span> <span class="token operator">:</span> <span class="token constant">ESBUILD_MODULES_TARGET</span><span class="token punctuation">,</span>
  external<span class="token operator">:</span> config<span class="token punctuation">.</span>optimizeDeps<span class="token operator">?.</span>exclude<span class="token punctuation">,</span>
  logLevel<span class="token operator">:</span> <span class="token string">'error'</span><span class="token punctuation">,</span>
  splitting<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  sourcemap<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  outdir<span class="token operator">:</span> processingCacheDir<span class="token punctuation">,</span>
  ignoreAnnotations<span class="token operator">:</span> <span class="token operator">!</span>isBuild<span class="token punctuation">,</span>
  metafile<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token operator">...</span>plugins<span class="token punctuation">,</span>
    <span class="token function">esbuildDepPlugin</span><span class="token punctuation">(</span>flatIdDeps<span class="token punctuation">,</span> flatIdToExports<span class="token punctuation">,</span> config<span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token operator">...</span>esbuildOptions<span class="token punctuation">,</span>
  supported<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">'dynamic-import'</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token string-property property">'import-meta'</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token operator">...</span>esbuildOptions<span class="token punctuation">.</span>supported
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>以上代码是 <code>Vite</code> 借助 <code>esbuild</code> 的能力来进行预构建，以下简单过一下配置项。</p> <h3 id="entrypoints"><a href="#entrypoints" class="header-anchor">#</a> entryPoints</h3> <p><code>esbuild</code> 处理依赖预构建的入口, <code>Vite</code> 在处理依赖预构建的时候会将 <code>bare id</code> 进行扁平化处理，若不进行扁平化, 那么 <code>react/jsx-runtime</code> 就会打包成如下形式</p> <div class="language-bash extra-class"><pre class="language-bash"><code>.vite
└── deps_build-dist
    ├── node_modules
    │   └── react
    │       ├── jsx-runtime.js
    │       └── jsx-runtime.js.map
    └── package.json
</code></pre></div><p>增加路径解析复杂度, 但是 <code>esbuild</code> 无法得知扁平化后的路径具体指的是哪个路径，因此通过 <code>vite:dep-pre-bundle</code> 插件来做模块路径映射到绝对路径的处理。因此 <code>entryPoints</code> 会影响打包产物的格式，而值得注意的是，在早期 <code>esbuild</code> 版本( <code>0.8.34</code> )中，<code>path</code> 会影响打包产物的格式，而 <code>entryPoints</code> 并不会起到影响作用。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string-property property">'react_jsx-runtime'</span><span class="token operator">:</span> <span class="token string">'/Users/Project/vite/packages/vite/demo/node_modules/react/jsx-runtime.js'</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>Vite</code> 通过 <code>alias</code> 和 <code>vite:resolve</code> 插件来解析 <code>bare id</code> 并获取模块实际的绝对路径。</p> <h3 id="bundle"><a href="#bundle" class="header-anchor">#</a> bundle</h3> <p><code>bundle: true</code> 表明 <code>esbuild</code> 会将模块的依赖与模块自身打包成一个模块。</p> <h3 id="external"><a href="#external" class="header-anchor">#</a> external</h3> <p>依赖外置，不需要处理的模块。这个选项在做服务端渲染或者应用体积优化的时候经常用到。举个例子当开启了这个选项并做了一些配置时。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> React <span class="token keyword">from</span> <span class="token string">'react'</span>
</code></pre></div><p>打包后的代码仍然保留这段代码，而不是将 react 的代码打包进来。</p> <h3 id="format"><a href="#format" class="header-anchor">#</a> format</h3> <p><code>format: 'esm'</code> 表明 <code>esbuild</code> 输出模块格式为 <code>esm</code>。这里也可以为 <code>cjs</code>，<code>loadConfigFromFile</code> 加载配置文件的时候, 若配置模块为非 <code>esm</code> 模块，则会通过 <code>esbuild</code> 将模块打包成 <code>cjs</code>, 之后在 <code>loadConfigFromBundledFile</code> 中重写 <code>require.extensions['.js']</code> 来编译 <code>cjs</code> 模块，获取配置模块的信息。具体源码如下:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// vite/packages/vite/src/node/config.ts</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">loadConfigFromBundledFile</span><span class="token punctuation">(</span><span class="token parameter">fileName<span class="token punctuation">,</span> bundledCode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> realFileName <span class="token operator">=</span> fs$l<span class="token punctuation">.</span><span class="token function">realpathSync</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> defaultLoader <span class="token operator">=</span> _require<span class="token punctuation">.</span>extensions<span class="token punctuation">[</span><span class="token string">'.js'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  _require<span class="token punctuation">.</span>extensions<span class="token punctuation">[</span><span class="token string">'.js'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> filename</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>filename <span class="token operator">===</span> realFileName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      module<span class="token punctuation">.</span><span class="token function">_compile</span><span class="token punctuation">(</span>bundledCode<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">defaultLoader</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// clear cache in case of server restart</span>
  <span class="token keyword">delete</span> _require<span class="token punctuation">.</span>cache<span class="token punctuation">[</span>_require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> raw <span class="token operator">=</span> <span class="token function">_require</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  _require<span class="token punctuation">.</span>extensions<span class="token punctuation">[</span><span class="token string">'.js'</span><span class="token punctuation">]</span> <span class="token operator">=</span> defaultLoader<span class="token punctuation">;</span>
  <span class="token keyword">return</span> raw<span class="token punctuation">.</span>__esModule <span class="token operator">?</span> raw<span class="token punctuation">.</span>default <span class="token operator">:</span> raw<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">bundleConfigFile</span><span class="token punctuation">(</span><span class="token parameter">fileName<span class="token punctuation">,</span> isESM <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> importMetaUrlVarName <span class="token operator">=</span> <span class="token string">'__vite_injected_original_import_meta_url'</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">build$3</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">absWorkingDir</span><span class="token operator">:</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">entryPoints</span><span class="token operator">:</span> <span class="token punctuation">[</span>fileName<span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token literal-property property">outfile</span><span class="token operator">:</span> <span class="token string">'out.js'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">write</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token literal-property property">platform</span><span class="token operator">:</span> <span class="token string">'node'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">bundle</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token literal-property property">format</span><span class="token operator">:</span> isESM <span class="token operator">?</span> <span class="token string">'esm'</span> <span class="token operator">:</span> <span class="token string">'cjs'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">sourcemap</span><span class="token operator">:</span> <span class="token string">'inline'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">metafile</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token literal-property property">define</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token string-property property">'import.meta.url'</span><span class="token operator">:</span> importMetaUrlVarName
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'externalize-deps'</span><span class="token punctuation">,</span>
          <span class="token function">setup</span><span class="token punctuation">(</span><span class="token parameter">build</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            build<span class="token punctuation">.</span><span class="token function">onResolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">filter</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">.*</span><span class="token regex-delimiter">/</span></span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              <span class="token keyword">const</span> id <span class="token operator">=</span> args<span class="token punctuation">.</span>path<span class="token punctuation">;</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>id<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">'.'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>path$o<span class="token punctuation">.</span><span class="token function">isAbsolute</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token punctuation">{</span>
                  <span class="token literal-property property">external</span><span class="token operator">:</span> <span class="token boolean">true</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'inject-file-scope-variables'</span><span class="token punctuation">,</span>
          <span class="token function">setup</span><span class="token punctuation">(</span><span class="token parameter">build</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            build<span class="token punctuation">.</span><span class="token function">onLoad</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">filter</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.[cm]?[jt]s$</span><span class="token regex-delimiter">/</span></span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              <span class="token keyword">const</span> contents <span class="token operator">=</span> <span class="token keyword">await</span> fs$l<span class="token punctuation">.</span>promises<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>path<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">const</span> injectValues <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">const __dirname = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>path$o<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
                <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">const __filename = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
                <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">const </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>importMetaUrlVarName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token function">pathToFileURL</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">.</span>href<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
              <span class="token keyword">return</span> <span class="token punctuation">{</span>
                <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token function">isTS</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">'ts'</span> <span class="token operator">:</span> <span class="token string">'js'</span><span class="token punctuation">,</span>
                <span class="token literal-property property">contents</span><span class="token operator">:</span> injectValues <span class="token operator">+</span> contents
              <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> text <span class="token punctuation">}</span> <span class="token operator">=</span> result<span class="token punctuation">.</span>outputFiles<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">code</span><span class="token operator">:</span> text<span class="token punctuation">,</span>
      <span class="token literal-property property">dependencies</span><span class="token operator">:</span> result<span class="token punctuation">.</span>metafile <span class="token operator">?</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>metafile<span class="token punctuation">.</span>inputs<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>userConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Bundle config file and transpile it to cjs using esbuild.</span>
    <span class="token keyword">const</span> bundled <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">bundleConfigFile</span><span class="token punctuation">(</span>resolvedPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dependencies <span class="token operator">=</span> bundled<span class="token punctuation">.</span>dependencies<span class="token punctuation">;</span>
    userConfig <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">loadConfigFromBundledFile</span><span class="token punctuation">(</span>resolvedPath<span class="token punctuation">,</span> bundled<span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">debug</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">bundled config file loaded in </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="outdir"><a href="#outdir" class="header-anchor">#</a> outdir</h3> <p>预优化的缓存文件夹，默认为 <code>node_modules/.vite</code>。</p> <h3 id="plugins"><a href="#plugins" class="header-anchor">#</a> plugins</h3> <p><code>esbuildDepPlugin</code> 这个插件就是 Vite 在 esbuild 打包中最核心的逻辑了。让我们来看看他到底干了什么事情。<br>
在分析这个插件的源码之前，我们先看 esbuild 官方给的一个最简单的插件例子，来看看如何编写 esbuild 的插件，了解一个最基本的工作流程。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> envPlugin <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'env'</span><span class="token punctuation">,</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token parameter">build</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    build<span class="token punctuation">.</span><span class="token function">onResolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">filter</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^env$</span><span class="token regex-delimiter">/</span></span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">args</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">path</span><span class="token operator">:</span> args<span class="token punctuation">.</span>path<span class="token punctuation">,</span>
      <span class="token literal-property property">namespace</span><span class="token operator">:</span> <span class="token string">'env-ns'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    build<span class="token punctuation">.</span><span class="token function">onLoad</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">filter</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">.*</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token literal-property property">namespace</span><span class="token operator">:</span> <span class="token string">'env-ns'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">contents</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">'json'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'esbuild'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">entryPoints</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'app.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">bundle</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">outfile</span><span class="token operator">:</span> <span class="token string">'out.js'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>envPlugin<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>这里我们编写了一个名字为 env 的插件。它干了什么事情呢，比如我们有下面的这一段源代码</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">PATH</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'env'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">PATH is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">PATH</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
</code></pre></div><p><code>esbuild</code> 在 <code>onResolve</code> 阶段通过正则匹配( <code>GoLang</code> )到了 <code>env</code> 这个我们想 <code>import</code> 的模块，并且把它交给了一个名为 <code>env-ns</code> 的虚拟模块做最终的处理。在 <code>env-ns</code> 中，我们将当前的 <code>process.env</code> 环境变量 <code>stringify</code> 成 <code>json</code> 字符串的形式返回给了 <code>contents</code>。也就是 <code>env</code> 这个模块，最终返回的就是 <code>process.env</code> 的值</p> <p>简单了解 <code>esbuild</code> 插件的执行流程后，接下来可以看一下预构建流程中最重要的插件: <strong><code>esbuildDepPlugin</code></strong>。</p> <h3 id="esbuilddepplugin"><a href="#esbuilddepplugin" class="header-anchor">#</a> esbuildDepPlugin</h3> <h4 id="特定文件-external"><a href="#特定文件-external" class="header-anchor">#</a> 特定文件 external</h4> <p>第一个处理是对特定格式文件的 external 处理，因为这些文件 esbuild 要么无法处理要么不应该由它来处理，Vite 自身会有另外的专门针对这些类型文件的处理逻辑。</p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">const</span> externalTypes <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">'css'</span><span class="token punctuation">,</span>
  <span class="token comment">// supported pre-processor types</span>
  <span class="token string">'less'</span><span class="token punctuation">,</span>
  <span class="token string">'sass'</span><span class="token punctuation">,</span>
  <span class="token string">'scss'</span><span class="token punctuation">,</span>
  <span class="token string">'styl'</span><span class="token punctuation">,</span>
  <span class="token string">'stylus'</span><span class="token punctuation">,</span>
  <span class="token string">'pcss'</span><span class="token punctuation">,</span>
  <span class="token string">'postcss'</span><span class="token punctuation">,</span>
  <span class="token comment">// known SFC types</span>
  <span class="token string">'vue'</span><span class="token punctuation">,</span>
  <span class="token string">'svelte'</span><span class="token punctuation">,</span>
  <span class="token string">'marko'</span><span class="token punctuation">,</span>
  <span class="token string">'astro'</span><span class="token punctuation">,</span>
  <span class="token comment">// JSX/TSX may be configured to be compiled differently from how esbuild</span>
  <span class="token comment">// handles it by default, so exclude them as well</span>
  <span class="token string">'jsx'</span><span class="token punctuation">,</span>
  <span class="token string">'tsx'</span><span class="token punctuation">,</span>
  <span class="token operator">...</span><span class="token constant">KNOWN_ASSET_TYPES</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">KNOWN_ASSET_TYPES</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token comment">// images</span>
  <span class="token string">'png'</span><span class="token punctuation">,</span>
  <span class="token string">'jpe?g'</span><span class="token punctuation">,</span>
  <span class="token string">'jfif'</span><span class="token punctuation">,</span>
  <span class="token string">'pjpeg'</span><span class="token punctuation">,</span>
  <span class="token string">'pjp'</span><span class="token punctuation">,</span>
  <span class="token string">'gif'</span><span class="token punctuation">,</span>
  <span class="token string">'svg'</span><span class="token punctuation">,</span>
  <span class="token string">'ico'</span><span class="token punctuation">,</span>
  <span class="token string">'webp'</span><span class="token punctuation">,</span>
  <span class="token string">'avif'</span><span class="token punctuation">,</span>
  <span class="token comment">// media</span>
  <span class="token string">'mp4'</span><span class="token punctuation">,</span>
  <span class="token string">'webm'</span><span class="token punctuation">,</span>
  <span class="token string">'ogg'</span><span class="token punctuation">,</span>
  <span class="token string">'mp3'</span><span class="token punctuation">,</span>
  <span class="token string">'wav'</span><span class="token punctuation">,</span>
  <span class="token string">'flac'</span><span class="token punctuation">,</span>
  <span class="token string">'aac'</span><span class="token punctuation">,</span>
  <span class="token comment">// fonts</span>
  <span class="token string">'woff2?'</span><span class="token punctuation">,</span>
  <span class="token string">'eot'</span><span class="token punctuation">,</span>
  <span class="token string">'ttf'</span><span class="token punctuation">,</span>
  <span class="token string">'otf'</span><span class="token punctuation">,</span>
  <span class="token comment">// other</span>
  <span class="token string">'webmanifest'</span><span class="token punctuation">,</span>
  <span class="token string">'pdf'</span><span class="token punctuation">,</span>
  <span class="token string">'txt'</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// remove optimizable extensions from `externalTypes` list</span>
<span class="token keyword">const</span> allExternalTypes <span class="token operator">=</span> config<span class="token punctuation">.</span>optimizeDeps<span class="token punctuation">.</span>extensions
  <span class="token operator">?</span> externalTypes<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token operator">!</span>config<span class="token punctuation">.</span>optimizeDeps<span class="token punctuation">.</span>extensions<span class="token operator">?.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'.'</span> <span class="token operator">+</span> type<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token operator">:</span> externalTypes<span class="token punctuation">;</span>
<span class="token keyword">const</span> convertedExternalPrefix <span class="token operator">=</span> <span class="token string">'vite-dep-pre-bundle-external:'</span><span class="token punctuation">;</span>

build<span class="token punctuation">.</span><span class="token function">onResolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">filter</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\\.(</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span> allExternalTypes<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">)(\\?.*)?$</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> <span class="token literal-property property">path</span><span class="token operator">:</span> id<span class="token punctuation">,</span> importer<span class="token punctuation">,</span> kind <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// if the prefix exist, it is already converted to `import`, so set `external: true`</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>id<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>convertedExternalPrefix<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">path</span><span class="token operator">:</span> id<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>convertedExternalPrefix<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">external</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> resolved <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">resolve</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> importer<span class="token punctuation">,</span> kind<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>resolved<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果当前模块是使用 require 来进行调用.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>kind <span class="token operator">===</span> <span class="token string">'require-call'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// here it is not set to `external: true` to convert `require` to `import`</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">path</span><span class="token operator">:</span> resolved<span class="token punctuation">,</span>
        <span class="token literal-property property">namespace</span><span class="token operator">:</span> externalWithConversionNamespace
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">path</span><span class="token operator">:</span> resolved<span class="token punctuation">,</span>
      <span class="token literal-property property">external</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

build<span class="token punctuation">.</span><span class="token function">onLoad</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">filter</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">.</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token literal-property property">namespace</span><span class="token operator">:</span> externalWithConversionNamespace <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// import itself with prefix (this is the actual part of require-import conversion)</span>
  <span class="token comment">// 外部模块改为通过重导出的方式来进行处理。</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">contents</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">export { default } from &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>convertedExternalPrefix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>args<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;;</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">export * from &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>convertedExternalPrefix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>args<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">'js'</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>一个模块被设置为 <code>external</code> 之后，模块的代码就不会被 <code>esbuild</code> 打包到产物中，而是作为外部依赖被引入。预构建产物不需要关心 <code>external</code> 的具体处理方式, 处理方案交由给 <code>Vite Plugins</code> 来进行统一处理。</p> <p><strong>源代码:</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token string">'./style.css'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> getValue <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./demo1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'getValue: '</span><span class="token punctuation">,</span> getValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>打包后:</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>
  __esm<span class="token punctuation">,</span>
  __toCommonJS
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./chunk-MPUXO6CG.js&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// src/demo1.js</span>
<span class="token keyword">var</span> demo1_exports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> init_demo1 <span class="token operator">=</span> <span class="token function">__esm</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token string">&quot;src/demo1.js&quot;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>
    module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token function-variable function">add</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// src/commonjs.js</span>
<span class="token keyword">import</span> <span class="token string">&quot;/Users/chenjiaxiang/Project/vite/packages/vite/demo/src/style.css&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> getValue <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">init_demo1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">__toCommonJS</span><span class="token punctuation">(</span>demo1_exports<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;getValue: &quot;</span><span class="token punctuation">,</span> getValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//# sourceMappingURL=___src_commonjs__js.js.map</span>
</code></pre></div><p>可以看出 <code>css</code> 模块只是单纯的使用 <code>import</code> 导入模块的绝对路径，并没有做多余的处理。</p> <h4 id="区分入口模块和依赖模块"><a href="#区分入口模块和依赖模块" class="header-anchor">#</a> 区分入口模块和依赖模块</h4> <p>Vite 对入口模块和依赖模块使用了不同的处理规则，入口模块指依赖预构建的模块。而依赖模块则是入口模块自身的依赖也就是 dependencies
这里可以看到如果是入口模块，则交给 <code>namespace</code> 为 <code>dep</code> 的虚拟模块来进行处理，且我们只返回一个 <code>flatId</code> 作为模块的 <code>path</code>(历史原因, 下面有做解释)。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">resolveEntry</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">id</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> flatId <span class="token operator">=</span> <span class="token function">flattenId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>flatId <span class="token keyword">in</span> qualified<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">path</span><span class="token operator">:</span> flatId<span class="token punctuation">,</span>
      <span class="token literal-property property">namespace</span><span class="token operator">:</span> <span class="token string">'dep'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


build<span class="token punctuation">.</span><span class="token function">onResolve</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span> <span class="token literal-property property">filter</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^[\w@][^:]</span><span class="token regex-delimiter">/</span></span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> <span class="token literal-property property">path</span><span class="token operator">:</span> id<span class="token punctuation">,</span> importer<span class="token punctuation">,</span> kind <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 过滤 config.optimizeDeps?.exclude 中所包含的模块</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">moduleListContains</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>optimizeDeps<span class="token operator">?.</span>exclude<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">path</span><span class="token operator">:</span> id<span class="token punctuation">,</span>
        <span class="token literal-property property">external</span><span class="token operator">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ensure esbuild uses our resolved entries</span>
    <span class="token keyword">let</span> <span class="token literal-property property">entry</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">path</span><span class="token operator">:</span> string<span class="token punctuation">;</span> namespace<span class="token operator">:</span> string <span class="token punctuation">}</span> <span class="token operator">|</span> <span class="token keyword">undefined</span>
    <span class="token comment">// if this is an entry, return entry namespace resolve result</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>importer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>entry <span class="token operator">=</span> <span class="token function">resolveEntry</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> entry
      <span class="token comment">// check if this is aliased to an entry - also return entry namespace</span>
      <span class="token keyword">const</span> aliased <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">_resolve</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>aliased <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>entry <span class="token operator">=</span> <span class="token function">resolveEntry</span><span class="token punctuation">(</span>aliased<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> entry
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// use vite's own resolver</span>
    <span class="token keyword">const</span> resolved <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">resolve</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> importer<span class="token punctuation">,</span> kind<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>resolved<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">resolveResult</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> resolved<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre></div><h4 id="模块路径的解析"><a href="#模块路径的解析" class="header-anchor">#</a> 模块路径的解析</h4> <p>从上面可以发现 <code>esbuild</code> 对于模块路径的解析存在 <code>_resolve</code> 和 <code>resolve</code> 这两种方案。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// default resolver which prefers ESM</span>

<span class="token keyword">const</span> _resolve <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">createResolver</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">asSrc</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token literal-property property">scan</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// create an internal resolver to be used in special scenarios, e.g.</span>
<span class="token comment">// optimizer &amp; handling css @imports</span>
<span class="token keyword">const</span> <span class="token function-variable function">createResolver</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  container <span class="token operator">=</span>
    resolverContainer <span class="token operator">||</span>
      <span class="token punctuation">(</span>resolverContainer <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">createPluginContainer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token operator">...</span>resolved<span class="token punctuation">,</span>
        <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token function">alias$1</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">entries</span><span class="token operator">:</span> resolved<span class="token punctuation">.</span>resolve<span class="token punctuation">.</span>alias <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token function">resolvePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token operator">...</span>resolved<span class="token punctuation">.</span>resolve<span class="token punctuation">,</span>
            <span class="token literal-property property">root</span><span class="token operator">:</span> resolvedRoot<span class="token punctuation">,</span>
            isProduction<span class="token punctuation">,</span>
            <span class="token literal-property property">isBuild</span><span class="token operator">:</span> command <span class="token operator">===</span> <span class="token string">'build'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">ssrConfig</span><span class="token operator">:</span> resolved<span class="token punctuation">.</span>ssr<span class="token punctuation">,</span>
            <span class="token literal-property property">asSrc</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token literal-property property">preferRelative</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token literal-property property">tryIndex</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token operator">...</span>options
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">await</span> container<span class="token punctuation">.</span><span class="token function">resolveId</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> importer<span class="token punctuation">,</span> <span class="token punctuation">{</span> ssr <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?.</span>id<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以看出 <code>_resolve</code> 处理模块的路径依赖于 <code>alias</code> 和 <code>vite:resolve</code> 两大插件来进行顺序处理。当然分析 <code>resolve</code> 处理模块路径也是同 <code>_resolve</code>，需要依赖 <code>alias</code> 和 <code>vite:resolve</code> 两大插件。</p> <p><strong>alias 插件处理流程:</strong>
其实 <code>alias</code> 处理流程很简单，本质上就是处理用户 alias 配置项并替换掉模块路径的过程。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">resolveId</span><span class="token punctuation">(</span><span class="token parameter">importee<span class="token punctuation">,</span> importer<span class="token punctuation">,</span> resolveOptions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>importer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// First match is supposed to be the correct one</span>
    <span class="token keyword">const</span> matchedEntry <span class="token operator">=</span> config<span class="token punctuation">.</span>resolve<span class="token punctuation">.</span>alias<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">entry</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">matches</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>find<span class="token punctuation">,</span> importee<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>matchedEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 将 /@vite/client 替换成 /Users/Project/vite/packages/vite/dist/client/client.mjs 路径.</span>
    <span class="token keyword">const</span> updatedId <span class="token operator">=</span> importee<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>matchedEntry<span class="token punctuation">.</span>find<span class="token punctuation">,</span> matchedEntry<span class="token punctuation">.</span>replacement<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 若配置项中有配置 resolverFunction，那么就调用 resolverFunction 来对更换过的路径做处理，否则继续调用后续插件的 resolveId hook 做处理.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>matchedEntry<span class="token punctuation">.</span>resolverFunction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> matchedEntry<span class="token punctuation">.</span><span class="token function">resolverFunction</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> updatedId<span class="token punctuation">,</span> importer<span class="token punctuation">,</span> resolveOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>
            updatedId<span class="token punctuation">,</span> 
            importer<span class="token punctuation">,</span> 
            Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">skipSelf</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> 
            resolveOptions
          <span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolved</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> resolved <span class="token operator">||</span> <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> updatedId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>vite:resolve 插件处理流程:</strong>
这是 <code>Vite</code> 处理模块路径核心的插件，几乎所有重要的 Vite 特性都离不开这个插件的实现，诸如依赖预构建、HMR、SSR 等等。</p> <ul><li><p>commonjs代理模块的快速路径处理</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\?commonjs</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token operator">||</span> id <span class="token operator">===</span> <span class="token string">'commonjsHelpers.js'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>对于预构建模块路径的处理</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// resolve pre-bundled deps requests, these could be resolved by</span>
<span class="token comment">// tryFileResolve or /fs/ resolution but these files may not yet</span>
<span class="token comment">// exists if we are in the middle of a deps re-processing</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>asSrc <span class="token operator">&amp;&amp;</span> depsOptimizer<span class="token operator">?.</span><span class="token function">isOptimizedDepUrl</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> optimizedPath <span class="token operator">=</span> id<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token constant">FS_PREFIX</span><span class="token punctuation">)</span>
      <span class="token operator">?</span> <span class="token function">fsPathFromId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token function">normalizePath$3</span><span class="token punctuation">(</span><span class="token function">ensureVolumeInPath</span><span class="token punctuation">(</span>path$o<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> id<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> optimizedPath<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>对于以 <strong><code>/@fs/*</code></strong> 开头的路径处理</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">if</span> <span class="token punctuation">(</span>asSrc <span class="token operator">&amp;&amp;</span> id<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token constant">FS_PREFIX</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> fsPath <span class="token operator">=</span> <span class="token function">fsPathFromId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    res <span class="token operator">=</span> <span class="token function">tryFsResolve</span><span class="token punctuation">(</span>fsPath<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// always return here even if res doesn't exist since /@fs/ is explicit</span>
    <span class="token comment">// if the file doesn't exist it should be a 404</span>
    <span class="token keyword">return</span> res <span class="token operator">||</span> fsPath<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div></li> <li><p>对于以 <strong><code>/</code></strong> 开头的路径做处理</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">if</span> <span class="token punctuation">(</span>asSrc <span class="token operator">&amp;&amp;</span> id<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> fsPath <span class="token operator">=</span> path$o<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> id<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>res <span class="token operator">=</span> <span class="token function">tryFsResolve</span><span class="token punctuation">(</span>fsPath<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> res<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div></li> <li><p>对于以 <strong><code>.</code></strong> 或父模块以 <strong><code>.html</code></strong> 结尾的路径做处理</p></li> <li><p>对于绝对路径做处理</p></li> <li><p>对于以 <code>http</code> 或 <code>https</code> 引入的路径做处理</p></li> <li><p>对于 <code>data</code> url做处理</p></li> <li><p>对于 <code>Bare Import</code> 做处理</p> <ul><li>这里会去检测路径是否归属于预构建模块，若是的话则会通过 <code>depsOptimizer.registerMissingImport(id, resolved, ssr)</code> 为 <code>metadata.discovered</code> 添加新的预构建模块。</li></ul></li></ul> <h4 id="dep虚拟模块"><a href="#dep虚拟模块" class="header-anchor">#</a> dep虚拟模块</h4> <p>这块的工作基本上是预优化的核心内容。这里 Vite 只干了一件事情，就是生成了一个虚拟模块来导出原模块的原始 id。
举个例子，上面我们提到了 Vite 会把入口模块交给 namespace 为 <code>dep</code> 的流程去做进一步的处理。且只传递给了一个最原始的 Bare id (代码中引入的模块, <code>import runtime from 'react/jsx-runtime'</code>, <code>react/jsx-runtime</code> 即为 Bare id )。
Vite 在处理预构建模块的时候会获取模块的 <code>exportData</code> (导入和导出信息), 通过 <code>es-module-lexer</code> 包来获取模块的导入和导出信息，不过需要注意的是, <code>es-module-lexer</code> 包在处理含 <code>jsx</code> 模块的时候会报错, 因此 Vite 在解析报错的时候(<code>catch</code> 到)会通过 <code>esbuild</code> 配置 jsx loader 来解析 <code>jsx</code> 模块, <code>transfrom</code> 完成之后再使用 <code>es-module-lexer</code> 包解析模块获取模块的导入和导出信息。
当入口模块即没有 <code>import</code> 关键字 也没有 <code>export</code> 关键字时，我们认为它是一个 <code>cjs</code> 模块。生成的代理模块的格式如下:</p> <div class="language-js extra-class"><pre class="language-js"><code>contents <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">export default require(&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>relativePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;);</span><span class="token template-punctuation string">`</span></span>
</code></pre></div><p>当入口模块使用 <code>export default</code> 进行导出时，我们生成的代理模块的格式如下</p> <div class="language-js extra-class"><pre class="language-js"><code>contents <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">import d from &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>relativePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;;export default d;</span><span class="token template-punctuation string">`</span></span>
</code></pre></div><p>当入口模块存在 <code>ReExports</code> 时，比如 <code>export * from './xxx.js'</code> 或者 <code>export</code> 关键字出现的次数大于1，或者不存在 <code>export default</code>的时候生成的代理模块的格式如下
这也是大多数符合标准的模块最终处理完成的格式。</p> <div class="language-js extra-class"><pre class="language-js"><code>contents <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\nexport * from &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>relativePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span>
</code></pre></div><p>以 Vue 为例，当我们处理完之后。执行 <code>import Vue from 'vue'</code> 时，<code>'vue'</code> 实际返回的 contents 是 <code>export * from &quot;./node_modules/vue/dist/vue.runtime.esm-bundler.js&quot;</code></p> <p>具体源码如下</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> root <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>root<span class="token punctuation">)</span>
build<span class="token punctuation">.</span><span class="token function">onLoad</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">filter</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">.*</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token literal-property property">namespace</span><span class="token operator">:</span> <span class="token string">'dep'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> <span class="token literal-property property">path</span><span class="token operator">:</span> id <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> entryFile <span class="token operator">=</span> qualified<span class="token punctuation">[</span>id<span class="token punctuation">]</span>
  <span class="token keyword">let</span> relativePath <span class="token operator">=</span> <span class="token function">normalizePath</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">relative</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> entryFile<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>relativePath<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    relativePath <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>relativePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> contents <span class="token operator">=</span> <span class="token string">''</span>
  <span class="token keyword">const</span> data <span class="token operator">=</span> exportsData<span class="token punctuation">[</span>id<span class="token punctuation">]</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>imports<span class="token punctuation">,</span> exports<span class="token punctuation">]</span> <span class="token operator">=</span> data
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>imports<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>exports<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// cjs</span>
    contents <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">export default require(&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>relativePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;);</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>exports<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'default'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      contents <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">import d from &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>relativePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;;export default d;</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      data<span class="token punctuation">.</span>hasReExports <span class="token operator">||</span>
      exports<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">||</span>
      exports<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">'default'</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      contents <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\nexport * from &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>relativePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> ext <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>entryFile<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ext <span class="token operator">===</span> <span class="token string">'mjs'</span><span class="token punctuation">)</span> ext <span class="token operator">=</span> <span class="token string">'js'</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">loader</span><span class="token operator">:</span> ext <span class="token keyword">as</span> Loader<span class="token punctuation">,</span>
    contents<span class="token punctuation">,</span>
    <span class="token literal-property property">resolveDir</span><span class="token operator">:</span> root
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h5 id="到这肯定会有很大一部分疑惑-为什么需要专门设计虚拟模块-dep-来进行处理呢"><a href="#到这肯定会有很大一部分疑惑-为什么需要专门设计虚拟模块-dep-来进行处理呢" class="header-anchor">#</a> 到这肯定会有很大一部分疑惑，为什么需要专门设计虚拟模块(dep)来进行处理呢?</h5> <p>通过以下注释</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// For entry files, we'll read it ourselves and construct a proxy module</span>
<span class="token comment">// to retain the entry's raw id instead of file path so that esbuild</span>
<span class="token comment">// outputs desired output file structure.</span>
<span class="token comment">// It is necessary to do the re-exporting to separate the virtual proxy</span>
<span class="token comment">// module from the actual module since the actual module may get</span>
<span class="token comment">// referenced via relative imports - if we don't separate the proxy and</span>
<span class="token comment">// the actual module, esbuild will create duplicated copies of the same</span>
<span class="token comment">// module!</span>
</code></pre></div><p>我们可以看出这样设计的目的有两个</p> <ul><li>使 <code>esbuild</code> 最终输出符合期望的结构</li> <li>如果不分离虚拟模块和真实模块，<code>esbuild</code> 可能会重复打包相同模块</li></ul> <p>经过测试可以发现在 <code>esbuild</code> 新版本( <code>0.15.10</code> )中，产物输出的结构和 <code>entryPoints</code> 有关，因此通过插件直接重写路径(具体的模块路径)不会出现输出结构不符合期望的问题而也不会存在重复打包模块的问题。但是针对注释所处的 <code>esbuild</code> 版本( <code>0.8.34</code> )来说，测试的时候发现输出的结构和 <code>path</code> 有关系，因此不能直接通过插件重写路径，会存在非扁平化的效果，那么就想不改变 <code>path</code>，<code>path</code> 依旧为扁平化，通过 <code>load hook</code> 来读取模块的信息。结果通过 <code>fs</code> 读模块对于 <code>esbuild</code> 来说不可感知是否是同一模块，因此会导致打包重复产物的问题。那么 <code>fs</code> 这一条路就行不通了，后来就考虑可以通过重导出来的方式来进行 <code>load</code> 处理。这样就同时解决了产物非扁平化问题和重复打包模块的问题。
<img src="/assets/img/dep-unflatten.3973a1d4.png" alt="预构建产物非扁平化"></p> <div class="language-bash extra-class"><pre class="language-bash"><code>.vite
└── deps_build-dist_temp
    ├── chunk-CE3JUPYM.js
    <span class="token punctuation">..</span><span class="token punctuation">..</span>
    ├── chunk-UUP7NEEN.js.map
    ├── node_modules
    │   └── react
    │       ├── index.js
    │       ├── index.js.map
    │       ├── jsx-dev-runtime.js
    │       ├── jsx-dev-runtime.js.map
    │       ├── jsx-runtime.js
    │       └── jsx-runtime.js.map
    ├── package.json
    └── src
        ├── commonjs.js
        ├── commonjs.js.map
        ├── demo.js
        ├── demo.js.map
        ├── demo1.js
        └── demo1.js.map
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/guide/hmr.html" class="prev">
        热替换
      </a></span> <span class="next"><a href="/guide/2.0/ssr.html">
        SSR + Vite
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.0fb2595b.js" defer></script><script src="/assets/js/2.52a120d4.js" defer></script><script src="/assets/js/10.e4898816.js" defer></script>
  </body>
</html>
