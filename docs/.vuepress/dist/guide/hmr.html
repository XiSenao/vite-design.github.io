<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>热替换 | Vite Design</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="Vite 源码分析">
    <meta name="keywords" itemprop="keywords" content="vite 源码分析 Vue 前端开发,Vue.js,vue-cli">
    <meta property="og:title" content="vite 源码分析">
    <meta property="og:description" content="vite vue 源码分析 一个基于 Vue3 单文件组件的非打包开发服务器">
    
    <link rel="preload" href="/assets/css/0.styles.a67a2774.css" as="style"><link rel="preload" href="/assets/js/app.6a4c4a7b.js" as="script"><link rel="preload" href="/assets/js/2.52a120d4.js" as="script"><link rel="preload" href="/assets/js/3.ebe90f04.js" as="script"><link rel="prefetch" href="/assets/js/10.e13d819f.js"><link rel="prefetch" href="/assets/js/11.1e014dea.js"><link rel="prefetch" href="/assets/js/12.d913702a.js"><link rel="prefetch" href="/assets/js/13.d991647e.js"><link rel="prefetch" href="/assets/js/14.b06b28d3.js"><link rel="prefetch" href="/assets/js/15.ed12af1b.js"><link rel="prefetch" href="/assets/js/16.cf2608a6.js"><link rel="prefetch" href="/assets/js/4.f01d629c.js"><link rel="prefetch" href="/assets/js/5.a97d1a95.js"><link rel="prefetch" href="/assets/js/6.c4fa6fb2.js"><link rel="prefetch" href="/assets/js/7.13c26358.js"><link rel="prefetch" href="/assets/js/8.6f53c4a1.js"><link rel="prefetch" href="/assets/js/9.ed1c8010.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a67a2774.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Vite Design</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/guide/" class="nav-link router-link-active">
  Guide
</a></div><div class="nav-item"><a href="https://github.com/FinalAshen/vite-design.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/guide/" class="nav-link router-link-active">
  Guide
</a></div><div class="nav-item"><a href="https://github.com/FinalAshen/vite-design.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span></span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/" aria-current="page" class="sidebar-link">简介</a></li><li><a href="/guide/chinese-doc.html" class="sidebar-link">vite ⚡ 1.0 中文文档</a></li><li><a href="/guide/getting-start.html" class="sidebar-link">学习准备</a></li><li><a href="/guide/module-resolve.html" class="sidebar-link">模块解析</a></li><li><a href="/guide/optimize.html" class="sidebar-link">预优化</a></li><li><a href="/guide/render.html" class="sidebar-link">组件渲染</a></li><li><a href="/guide/hmr.html" aria-current="page" class="active sidebar-link">热替换</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/hmr.html#监听文件变化" class="sidebar-link">监听文件变化</a></li><li class="sidebar-sub-header"><a href="/guide/hmr.html#css-热替换" class="sidebar-link">css 热替换</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/hmr.html#css-导入关系链" class="sidebar-link">css 导入关系链</a></li><li class="sidebar-sub-header"><a href="/guide/hmr.html#normalcssupdate" class="sidebar-link">normalCssUpdate</a></li><li class="sidebar-sub-header"><a href="/guide/hmr.html#modulecssupdate" class="sidebar-link">moduleCssUpdate</a></li><li class="sidebar-sub-header"><a href="/guide/hmr.html#vuestyleupdate" class="sidebar-link">vueStyleUpdate</a></li></ul></li><li class="sidebar-sub-header"><a href="/guide/hmr.html#js-热替换" class="sidebar-link">js 热替换</a></li><li class="sidebar-sub-header"><a href="/guide/hmr.html#vue-组件热替换" class="sidebar-link">vue 组件热替换</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/hmr.html#更新类型" class="sidebar-link">更新类型</a></li><li class="sidebar-sub-header"><a href="/guide/hmr.html#客户端接收消息" class="sidebar-link">客户端接收消息</a></li><li class="sidebar-sub-header"><a href="/guide/hmr.html#总结" class="sidebar-link">总结</a></li></ul></li></ul></li><li><a href="/guide/2.0/optimize.html" class="sidebar-link">预优化 2.0</a></li><li><a href="/guide/2.0/ssr.html" class="sidebar-link">SSR + Vite</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="热替换"><a href="#热替换" class="header-anchor">#</a> 热替换</h1> <p>热替换(Hot Module Replacement) 指的是修改代码后无需刷新页面即可生效。经常跟 <code>Hot Module Reload</code> 搞混。一个成熟的框架是必须要具备热替换能力的。Vite 的热替换实现与业界知名的一些模块如 <code>webpack-dev-server</code> 的实现类似。本质都是通过 websocket 建立服务端与浏览器的通信。如果对 <code>WebSocket</code> 不了解的可能需要先去学习下相关知识点。这里我们将分别分析修改几种不同类型的文件如 <code>.vue</code>, <code>.js</code>, <code>.css</code> 文件的热替换机制在 Vite 是具体如何实现的。同时也会分析 Vite 提供的热替换相关的 API，如: <code>import.meta.hot</code></p> <h2 id="监听文件变化"><a href="#监听文件变化" class="header-anchor">#</a> 监听文件变化</h2> <p>首先服务端向浏览器发送消息肯定是在文件有变动才发送。在 webpack 的生态中，大多数 middleware/plugin 都是通过监听 webpack 提供的一些钩子函数，如下方代码摘自 webpack-dev-server 源码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">addHooks</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> compile<span class="token punctuation">,</span> invalid<span class="token punctuation">,</span> done <span class="token punctuation">}</span> <span class="token operator">=</span> compiler<span class="token punctuation">.</span>hooks
    done<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'webpack-dev-server'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">stats</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 通过开启webpack --watch选项，在webpack每次编译完新的文件时，触发这个钩子，向sockjs发送新的message，内容为新的静态资源的hash</span>
        <span class="token comment">// 在_sendStats方法末尾会根据当前编译情况发送error/warning/ok三种类型的message给client</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_sendStats</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sockets<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getStats</span><span class="token punctuation">(</span>stats<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Node.js 本身提供了官方的 API 例如 fs.watch fs.watchFile 来监听文件的变化，Vite 则使用了这些 API 更上层的封装模块 <a href="https://www.npmjs.com/package/chokidar" target="_blank" rel="noopener noreferrer">chokidar<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 来进行文件系统的变动监听。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src/node/server/index.ts</span>
<span class="token comment">// 监听整个项目根目录。忽略 node_modules 和 .git 文件夹</span>
<span class="token keyword">const</span> watcher <span class="token operator">=</span> chokidar<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">ignored</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\bnode_modules\b</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\b\.git\b</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">as</span> HMRWatcher
</code></pre></div><h2 id="css-热替换"><a href="#css-热替换" class="header-anchor">#</a> css 热替换</h2> <p>有两种情况都可以修改样式，一种是修改外部 css 源文件。例如 <code>import './index.css'</code>, 或者直接改 Vue 组件的 style 标签。这两种修改方式的热更新策略也不一样。</p> <div class="language-js extra-class"><pre class="language-js"><code>  watcher<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'change'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">filePath</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isCSSRequest</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> publicPath <span class="token operator">=</span> resolver<span class="token punctuation">.</span><span class="token function">fileToRequest</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>srcImportMap<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// handle HMR for &lt;style src=&quot;xxx.css&quot;&gt;</span>
        <span class="token comment">// it cannot be handled as simple css import because it may be scoped</span>
        <span class="token keyword">const</span> styleImport <span class="token operator">=</span> srcImportMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span>
        vueCache<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span>
        <span class="token function">vueStyleUpdate</span><span class="token punctuation">(</span>styleImport<span class="token punctuation">)</span>
        <span class="token keyword">return</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>查看注释我们可以知道当我们使用 <code>&lt;style src=&quot;xxx.css&quot;&gt;</code> 这种方式来引入外部 css 文件，且文件变动时，需要执行 <code>vueStyleUpdate</code> 。我们不能简单的把它当作一个外部的 css 文件来处理。因为它可能是 scoped 局部作用域的。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>filePath<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'.module'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">moduleCssUpdate</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> resolver<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> boundaries <span class="token operator">=</span> <span class="token function">getCssImportBoundaries</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>boundaries<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> boundary <span class="token keyword">of</span> boundaries<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>boundary<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'.module'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">moduleCssUpdate</span><span class="token punctuation">(</span>boundary<span class="token punctuation">,</span> resolver<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>boundary<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'.vue'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      vueCache<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span><span class="token function">cleanUrl</span><span class="token punctuation">(</span>boundary<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token function">vueStyleUpdate</span><span class="token punctuation">(</span>resolver<span class="token punctuation">.</span><span class="token function">fileToRequest</span><span class="token punctuation">(</span>boundary<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">normalCssUpdate</span><span class="token punctuation">(</span>resolver<span class="token punctuation">.</span><span class="token function">fileToRequest</span><span class="token punctuation">(</span>boundary<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span>
<span class="token punctuation">}</span>
<span class="token comment">// no boundaries</span>
<span class="token function">normalCssUpdate</span><span class="token punctuation">(</span>publicPath<span class="token punctuation">)</span>
</code></pre></div><h3 id="css-导入关系链"><a href="#css-导入关系链" class="header-anchor">#</a> css 导入关系链</h3> <p>以以下代码为例
<img src="/assets/img/cssmodules3.2acf43b1.png" alt=""></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> boundaries <span class="token operator">=</span> <span class="token function">getCssImportBoundaries</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span>
</code></pre></div><p>这一行代码就是获取当前文件在 css 层级被导入关系链。包括独立的 css 文件以及 vue 组件的 style 标签
举个例子</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src/index.module.css</span>
<span class="token punctuation">.</span>big <span class="token punctuation">{</span>
  <span class="token literal-property property">width</span><span class="token operator">:</span> 200px
<span class="token punctuation">}</span>
<span class="token comment">// src/index.css</span>
@<span class="token keyword">import</span> <span class="token string">'./index.module.css'</span><span class="token punctuation">;</span>

</code></pre></div><p>这时候 index.module.css 就是 index.css 的依赖(dependencies), Vite 会生成两个 Map 对象分别存储导入者，和被导入者的依赖关系</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// cssImporterMap 被导入关系链</span>
<span class="token function">Map</span><span class="token punctuation">(</span><span class="token parameter"><span class="token number">1</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token string">'/Users/yuuang/Desktop/github/vite_test/src/index.module.css'</span> <span class="token operator">=&gt;</span> <span class="token function">Set</span><span class="token punctuation">(</span><span class="token parameter"><span class="token number">1</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token string">'/Users/yuuang/Desktop/github/vite_test/src/index.css'</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// cssImporteeMap 导入关系链</span>
<span class="token function">Map</span><span class="token punctuation">(</span><span class="token parameter"><span class="token number">3</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token string">'/Users/yuuang/Desktop/github/vite_test/src/App.vue?type=style&amp;index=0'</span> <span class="token operator">=&gt;</span> <span class="token function">Set</span><span class="token punctuation">(</span><span class="token parameter"><span class="token number">0</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">'/Users/yuuang/Desktop/github/vite_test/src/index.module.css'</span> <span class="token operator">=&gt;</span> <span class="token function">Set</span><span class="token punctuation">(</span><span class="token parameter"><span class="token number">0</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">'/Users/yuuang/Desktop/github/vite_test/src/index.css'</span> <span class="token operator">=&gt;</span> <span class="token function">Set</span><span class="token punctuation">(</span><span class="token parameter"><span class="token number">1</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token string">'/Users/yuuang/Desktop/github/vite_test/src/index.module.css'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>举个例子。当我们修改 <code>src/index.module.css</code> 时，那么依赖这个文件的文件都需要根据以下策略进行对应的更新。<br>
即修改 <code>src/index.module.css</code> 时， <code>src/index.css</code> 也需要更新</p> <p>我们可以看到 css 的更新策略分为三种</p> <p>1、<code>normalCssUpdate:</code> 普通的外部 css 文件更新 例如 <code>import './index.css'</code><br>
2、<code>moduleCssUpdate:</code> 当 import 的 css 文件包含 .module 关键字时文件变动时, 或者 被导入关系链上含有 .module 文件。<br>
3、<code>vueStyleUpdate:</code> 当通过 <code>&lt;style src=&quot;xxx.css&quot;&gt;</code> 这种方式导入的文件变动时，或者被导入关系链上含有 .vue 文件</p> <p>接下来让我们分别分析三种更新策略的具体行为</p> <h3 id="normalcssupdate"><a href="#normalcssupdate" class="header-anchor">#</a> normalCssUpdate</h3> <p>普通的外部 css 文件更新例如 <code>import './index.css'</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">normalCssUpdate</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">publicPath</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// bust process cache</span>
  processedCSS<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>publicPath<span class="token punctuation">)</span>

  watcher<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'style-update'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">path</span><span class="token operator">:</span> publicPath<span class="token punctuation">,</span>
    <span class="token literal-property property">changeSrcPath</span><span class="token operator">:</span> publicPath<span class="token punctuation">,</span>
    <span class="token literal-property property">timestamp</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre></div><p>通过 WebSocket 向浏览器发送了类型为 <code>style-update</code> 的消息并且附带修改的文件地址 <code>src/index.css</code></p> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token keyword">case</span> <span class="token string">'style-update'</span><span class="token operator">:</span>
      <span class="token comment">// check if this is referenced in html via &lt;link&gt;</span>
      <span class="token keyword">const</span> el <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">link[href*='</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">']</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        el<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>
          <span class="token string">'href'</span><span class="token punctuation">,</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">'&amp;'</span> <span class="token operator">:</span> <span class="token string">'?'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">t=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>timestamp<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// imported CSS</span>
      <span class="token keyword">const</span> importQuery <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">'&amp;import'</span> <span class="token operator">:</span> <span class="token string">'?import'</span>
      <span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>importQuery<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;t=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>timestamp<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[vite] </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> updated.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      <span class="token keyword">break</span>
</code></pre></div><p>浏览器接收到该消息后做的事情也非常简单，根据传入的 path 在后面拼接上类型为 import 的 query 参数。并且附上时间参数 t 防止被缓存。接着使用 import 关键字让浏览器发起一个最新的 css 文件的请求
<code>/src/index.css?import&amp;t=1598530856590</code></p> <h3 id="modulecssupdate"><a href="#modulecssupdate" class="header-anchor">#</a> moduleCssUpdate</h3> <p>针对使用了 <a href="https://github.com/css-modules/css-modules" target="_blank" rel="noopener noreferrer">css-modules<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的文件的更新<br>
首先要对 css-modules 有个基本的了解。如果没有开启 css-modules, 当我们使用 <code>import style from './index.css'</code>时，并不能得到具体的对象。在 Vite 中针对这种普通 css 文件将会导出 css 字符串。<br> <img src="/assets/img/cssmodules1.f7c3a44c.png" alt="">
当我们开启 css-modules 后，通过 <code>import style from './index.module.css'</code> 可以得到具体的 css 类名关系映射对象
<img src="/assets/img/cssmodules2.41c84a38.png" alt=""></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">moduleCssUpdate</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">filePath</span><span class="token operator">:</span> string<span class="token punctuation">,</span> <span class="token literal-property property">resolver</span><span class="token operator">:</span> InternalResolver</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// bust process cache</span>
  processedCSS<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>resolver<span class="token punctuation">.</span><span class="token function">fileToRequest</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span>

  watcher<span class="token punctuation">.</span><span class="token function">handleJSReload</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>因为启动了 css-modules 实质是导出一个对象。我们可以把这个文件当作 js 文件来看待。所以更新策略与我们后面讲到的 js 文件的热更新策略是一样的，接着让我们看看 handleJSReload 究竟干了什么</p> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token keyword">const</span> handleJSReload <span class="token operator">=</span> <span class="token punctuation">(</span>watcher<span class="token punctuation">.</span><span class="token function-variable function">handleJSReload</span> <span class="token operator">=</span> <span class="token punctuation">(</span>
    <span class="token parameter"><span class="token literal-property property">filePath</span><span class="token operator">:</span> string<span class="token punctuation">,</span>
    <span class="token literal-property property">timestamp</span><span class="token operator">:</span> number <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
  <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> publicPath <span class="token operator">=</span> resolver<span class="token punctuation">.</span><span class="token function">fileToRequest</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span>
    <span class="token keyword">const</span> importers <span class="token operator">=</span> importerMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>publicPath<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre></div><p>首先获取被导入关系链，找到依赖 <code>index.module.css</code> 的文件，这里的 importers 是 App.vue</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> dirtyFiles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
dirtyFiles<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>publicPath<span class="token punctuation">)</span>

<span class="token keyword">const</span> hasDeadEnd <span class="token operator">=</span> <span class="token function">walkImportChain</span><span class="token punctuation">(</span>
  publicPath<span class="token punctuation">,</span>
  importers <span class="token operator">||</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  hmrBoundaries<span class="token punctuation">,</span>
  dirtyFiles
<span class="token punctuation">)</span>
</code></pre></div><p>我们将当前文件 <code>src/index/module.css</code> 加入脏文件的集合当中，因为当前文件需要修改。接着我们通过 walkImportChain 顾名思义，遍历导入链。做一些信息收集操作。并且判断需不需要页面的全量更新即页面刷新。这里的 importers 导入链只包含直接使用 import 关键字的文件。比如在 App.vue 中 <code>import style from './index.module.css'</code> 或者 main.js 中 <code>import style from './index.module.css'</code>。如果是在另一个 css 文件通过 <code>@import './index.module.css'</code> 的方式导入则不会被计入导入链</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 在这个例子里我们称 App.vue 为导入模块 称 index.module.css 为被导入模块</span>
<span class="token keyword">function</span> <span class="token function">walkImportChain</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">importee</span><span class="token operator">:</span> string<span class="token punctuation">,</span>
  <span class="token literal-property property">importers</span><span class="token operator">:</span> Set<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">hmrBoundaries</span><span class="token operator">:</span> Set<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">dirtyFiles</span><span class="token operator">:</span> Set<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">currentChain</span><span class="token operator">:</span> string<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>hmrDeclineSet<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>importee<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果模块明确通过 import.meta.hot.decline 拒绝热更新，则直接页面刷新返回 true</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isHmrAccepted</span><span class="token punctuation">(</span>importee<span class="token punctuation">,</span> importee<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果模块通过 import.meta.hot.accept 接收自身的更新则直接返回 false 不需要刷新</span>
    hmrBoundaries<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>importee<span class="token punctuation">)</span>
    dirtyFiles<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>importee<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> importer <span class="token keyword">of</span> importers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      importer<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'.vue'</span><span class="token punctuation">)</span> <span class="token operator">||</span>
      <span class="token comment">// 如果导入模块 通过 import.meta.hot.acceptDeps 接收了被导入模块的更新通知</span>
      <span class="token function">isHmrAccepted</span><span class="token punctuation">(</span>importer<span class="token punctuation">,</span> importee<span class="token punctuation">)</span> <span class="token operator">||</span>
      <span class="token comment">// 如果导入模块通过 import.meta.hot.accept 接收自身的更新</span>
      <span class="token function">isHmrAccepted</span><span class="token punctuation">(</span>importer<span class="token punctuation">,</span> importer<span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果导入模块是 vue 组件，则添加进 脏文件，代表此文件需要被更新</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>importer<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'.vue'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dirtyFiles<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>importer<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      hmrBoundaries<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>importer<span class="token punctuation">)</span>
      currentChain<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> dirtyFiles<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果导入模块不是 vue 组件则走else分支</span>
      <span class="token comment">// 这里的导入模块可以是 js 文件，比如我们在 main.js 里面 import style from './index.module.css'</span>
      <span class="token comment">// 如果走到了这个else分支且没有更上层的导入模块。则认为该模块的导入链都是js文件且最上层的文件是main.js。这种情况需要整个页面刷新</span>
      <span class="token keyword">const</span> parentImpoters <span class="token operator">=</span> importerMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>importer<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>parentImpoters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>currentChain<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>importer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果有更上层的导入模块则继续递归判断上层模块一直往上找</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>
          <span class="token function">walkImportChain</span><span class="token punctuation">(</span>
            importer<span class="token punctuation">,</span>
            parentImpoters<span class="token punctuation">,</span>
            hmrBoundaries<span class="token punctuation">,</span>
            dirtyFiles<span class="token punctuation">,</span>
            currentChain<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>importer<span class="token punctuation">)</span>
          <span class="token punctuation">)</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre></div><p>结合上面的分析，其实我们只需要关注什么情况下会返回 true 的情况即可。因为这种情况需要整个页面 reload。大部分情况下我们都不会走到这个逻辑。即只有当你修改的文件的最顶层导入模块是 main.js 的时候才需要进行页面的 reload</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>hasDeadEnd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'full-reload'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">path</span><span class="token operator">:</span> publicPath
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span><span class="token function">green</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[vite] </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">page reloaded.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果 hasDeadEnd 为 true 则进行整个页面的 reload</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> boundaries <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>hmrBoundaries<span class="token punctuation">]</span>
  <span class="token keyword">const</span> file <span class="token operator">=</span>
    boundaries<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">?</span> boundaries<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>boundaries<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> files</span><span class="token template-punctuation string">`</span></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
    chalk<span class="token punctuation">.</span><span class="token function">green</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[vite:hmr] </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span> <span class="token operator">+</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>file<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> hot updated due to change in </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>relativeFile<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">)</span>
  <span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'multi'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">updates</span><span class="token operator">:</span> boundaries<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">boundary</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> boundary<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'vue'</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">'vue-reload'</span> <span class="token operator">:</span> <span class="token string">'js-update'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">path</span><span class="token operator">:</span> boundary<span class="token punctuation">,</span>
        <span class="token literal-property property">changeSrcPath</span><span class="token operator">:</span> publicPath<span class="token punctuation">,</span>
        timestamp
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>接着是不需要全量更新的情况。处理方式也很简单。我们遍历导入链。根据链上的每个文件的类型，发送对应的更新消息给客户端。这里我们的导入链上只有 App.vue。<br>
所以发送 vue-reload 的消息</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">case</span> <span class="token string">'vue-reload'</span><span class="token operator">:</span>
      <span class="token function">queueUpdate</span><span class="token punctuation">(</span>
        <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?t=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>timestamp<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">warnFailedFetch</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">m</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            __VUE_HMR_RUNTIME__<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> m<span class="token punctuation">.</span>default<span class="token punctuation">)</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[vite] </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> reloaded.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
      <span class="token keyword">break</span>
</code></pre></div><p>这里维护了一个队列，来保证组件的更新顺序是先进先出。
<img src="/assets/img/vue-reload.9ba94b51.png" alt=""></p> <p>可以看到页面重新请求了一个新的 App.vue 文件。且由于这个新文件的代码中包含新的带有时间参数t的 index.module.css 请求。所以我们也同样发起请求获取了新的 index.module.css 文件。</p> <h3 id="vuestyleupdate"><a href="#vuestyleupdate" class="header-anchor">#</a> vueStyleUpdate</h3> <p>修改 vue 组件 style 标签样式</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">function</span> <span class="token function">vueStyleUpdate</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">styleImport</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> publicPath <span class="token operator">=</span> <span class="token function">cleanUrl</span><span class="token punctuation">(</span>styleImport<span class="token punctuation">)</span>
    <span class="token keyword">const</span> index <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>styleImport<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>index
    <span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>publicPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?type=style&amp;index=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span><span class="token function">green</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[vite:hmr] </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>publicPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> updated. (style)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    watcher<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'style-update'</span><span class="token punctuation">,</span>
      path<span class="token punctuation">,</span>
      <span class="token literal-property property">changeSrcPath</span><span class="token operator">:</span> path<span class="token punctuation">,</span>
      <span class="token literal-property property">timestamp</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>处理方式也非常简单。找到修改的具体组件发起新的请求且请求类型为 style
<img src="/assets/img/vuestyle.c76038ae.png" alt="">
可以看的新的请求只包含我们修改的新样式</p> <h2 id="js-热替换"><a href="#js-热替换" class="header-anchor">#</a> js 热替换</h2> <p>js 文件的热更新其实在上面分析 css-modules 时已经顺带提到了。会被 handleJSReload
这个方法处理。处理结果也是两种</p> <ul><li>导入链最上层是 main.js 这种情况页面 reload</li> <li>不需要全量更新，根据导入链发起新文件的请求</li></ul> <h2 id="vue-组件热替换"><a href="#vue-组件热替换" class="header-anchor">#</a> vue 组件热替换</h2> <p>vue 组件的热替换分为以下几种情况</p> <ul><li><code>vue-rerender</code> 只发起请求类型为 template 的请求。无需请求整个完整的新组件</li> <li><code>vue-reload</code> 发起新组件的完整请求</li> <li><code>style-update</code> style 标签更新</li> <li><code>style-remove</code> style 标签移除</li></ul> <p>接下来我们来分析每种情况的更新时机</p> <h3 id="更新类型"><a href="#更新类型" class="header-anchor">#</a> 更新类型</h3> <p>发起新组件的完整请求</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//src/node/server/serverPluginVue.ts</span>
watcher<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'change'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'.vue'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">handleVueReload</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>vue 文件修改时触发 handleVueReload 方法</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> descriptor <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">parseSFC</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> filePath<span class="token punctuation">,</span> content<span class="token punctuation">)</span>
</code></pre></div><p>首先用官方提供的库来将单文件组件编译成 descriptor。这里我们摘出比较重要的信息省略 sourcemap信息。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">'/Users/yuuang/Desktop/github/vite_test/src/App.vue'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">source</span><span class="token operator">:</span> <span class="token string">'&lt;template&gt;\n'</span> <span class="token operator">+</span>
    <span class="token string">'  &lt;img alt=&quot;Vue logo&quot; src=&quot;./assets/logo.png&quot; :class=&quot;style.big&quot;/&gt;\n'</span> <span class="token operator">+</span>
    <span class="token string">'  &lt;div class=&quot;small&quot;&gt;\n'</span> <span class="token operator">+</span>
    <span class="token string">'    small1\n'</span> <span class="token operator">+</span>
    <span class="token string">'  &lt;/div&gt;\n'</span> <span class="token operator">+</span>
    <span class="token string">'  &lt;HelloWorld msg=&quot;Hello Vue 3.0 + Vite&quot; /&gt;\n'</span> <span class="token operator">+</span>
    <span class="token string">'&lt;/template&gt;\n'</span> <span class="token operator">+</span>
    <span class="token string">'\n'</span> <span class="token operator">+</span>
    <span class="token string">'&lt;script&gt;\n'</span> <span class="token operator">+</span>
    <span class="token string">&quot;import HelloWorld from './components/HelloWorld.vue'\n&quot;</span> <span class="token operator">+</span>
    <span class="token string">&quot;import style from './index.module.css'\n&quot;</span> <span class="token operator">+</span>
    <span class="token string">'\n'</span> <span class="token operator">+</span>
    <span class="token string">'export default {\n'</span> <span class="token operator">+</span>
    <span class="token string">&quot;  name: 'App',\n&quot;</span> <span class="token operator">+</span>
    <span class="token string">'  components: {\n'</span> <span class="token operator">+</span>
    <span class="token string">'    HelloWorld\n'</span> <span class="token operator">+</span>
    <span class="token string">'  },\n'</span> <span class="token operator">+</span>
    <span class="token string">'  data() {\n'</span> <span class="token operator">+</span>
    <span class="token string">'    return {\n'</span> <span class="token operator">+</span>
    <span class="token string">'      style: style\n'</span> <span class="token operator">+</span>
    <span class="token string">'    }\n'</span> <span class="token operator">+</span>
    <span class="token string">'  },\n'</span> <span class="token operator">+</span>
    <span class="token string">'  mounted () {\n'</span> <span class="token operator">+</span>
    <span class="token string">&quot;    console.log('mounted')\n&quot;</span> <span class="token operator">+</span>
    <span class="token string">'  }\n'</span> <span class="token operator">+</span>
    <span class="token string">'}\n'</span> <span class="token operator">+</span>
    <span class="token string">'&lt;/script&gt;\n'</span> <span class="token operator">+</span>
    <span class="token string">'\n'</span> <span class="token operator">+</span>
    <span class="token string">'&lt;style&gt;\n'</span> <span class="token operator">+</span>
    <span class="token string">'.small {\n'</span> <span class="token operator">+</span>
    <span class="token string">'  width:21px\n'</span> <span class="token operator">+</span>
    <span class="token string">'}\n'</span> <span class="token operator">+</span>
    <span class="token string">'&lt;/style&gt;\n'</span> <span class="token operator">+</span>
    <span class="token string">'\n'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">template</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'template'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token string">'\n'</span> <span class="token operator">+</span>
      <span class="token string">'  &lt;img alt=&quot;Vue logo&quot; src=&quot;./assets/logo.png&quot; :class=&quot;style.big&quot;/&gt;\n'</span> <span class="token operator">+</span>
      <span class="token string">'  &lt;div class=&quot;small&quot;&gt;\n'</span> <span class="token operator">+</span>
      <span class="token string">'    small1\n'</span> <span class="token operator">+</span>
      <span class="token string">'  &lt;/div&gt;\n'</span> <span class="token operator">+</span>
      <span class="token string">'  &lt;HelloWorld msg=&quot;Hello Vue 3.0 + Vite&quot; /&gt;\n'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">loc</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">source</span><span class="token operator">:</span> <span class="token string">'\n'</span> <span class="token operator">+</span>
        <span class="token string">'  &lt;img alt=&quot;Vue logo&quot; src=&quot;./assets/logo.png&quot; :class=&quot;style.big&quot;/&gt;\n'</span> <span class="token operator">+</span>
        <span class="token string">'  &lt;div class=&quot;small&quot;&gt;\n'</span> <span class="token operator">+</span>
        <span class="token string">'    small1\n'</span> <span class="token operator">+</span>
        <span class="token string">'  &lt;/div&gt;\n'</span> <span class="token operator">+</span>
        <span class="token string">'  &lt;HelloWorld msg=&quot;Hello Vue 3.0 + Vite&quot; /&gt;\n'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">start</span><span class="token operator">:</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token literal-property property">end</span><span class="token operator">:</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">attrs</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">map</span><span class="token operator">:</span> xxx
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">script</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'script'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token string">'\n'</span> <span class="token operator">+</span>
      <span class="token string">&quot;import HelloWorld from './components/HelloWorld.vue'\n&quot;</span> <span class="token operator">+</span>
      <span class="token string">&quot;import style from './index.module.css'\n&quot;</span> <span class="token operator">+</span>
      <span class="token string">'\n'</span> <span class="token operator">+</span>
      <span class="token string">'export default {\n'</span> <span class="token operator">+</span>
      <span class="token string">&quot;  name: 'App',\n&quot;</span> <span class="token operator">+</span>
      <span class="token string">'  components: {\n'</span> <span class="token operator">+</span>
      <span class="token string">'    HelloWorld\n'</span> <span class="token operator">+</span>
      <span class="token string">'  },\n'</span> <span class="token operator">+</span>
      <span class="token string">'  data() {\n'</span> <span class="token operator">+</span>
      <span class="token string">'    return {\n'</span> <span class="token operator">+</span>
      <span class="token string">'      style: style\n'</span> <span class="token operator">+</span>
      <span class="token string">'    }\n'</span> <span class="token operator">+</span>
      <span class="token string">'  },\n'</span> <span class="token operator">+</span>
      <span class="token string">'  mounted () {\n'</span> <span class="token operator">+</span>
      <span class="token string">&quot;    console.log('mounted')\n&quot;</span> <span class="token operator">+</span>
      <span class="token string">'  }\n'</span> <span class="token operator">+</span>
      <span class="token string">'}\n'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">loc</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">source</span><span class="token operator">:</span> <span class="token string">'\n'</span> <span class="token operator">+</span>
        <span class="token string">&quot;import HelloWorld from './components/HelloWorld.vue'\n&quot;</span> <span class="token operator">+</span>
        <span class="token string">&quot;import style from './index.module.css'\n&quot;</span> <span class="token operator">+</span>
        <span class="token string">'\n'</span> <span class="token operator">+</span>
        <span class="token string">'export default {\n'</span> <span class="token operator">+</span>
        <span class="token string">&quot;  name: 'App',\n&quot;</span> <span class="token operator">+</span>
        <span class="token string">'  components: {\n'</span> <span class="token operator">+</span>
        <span class="token string">'    HelloWorld\n'</span> <span class="token operator">+</span>
        <span class="token string">'  },\n'</span> <span class="token operator">+</span>
        <span class="token string">'  data() {\n'</span> <span class="token operator">+</span>
        <span class="token string">'    return {\n'</span> <span class="token operator">+</span>
        <span class="token string">'      style: style\n'</span> <span class="token operator">+</span>
        <span class="token string">'    }\n'</span> <span class="token operator">+</span>
        <span class="token string">'  },\n'</span> <span class="token operator">+</span>
        <span class="token string">'  mounted () {\n'</span> <span class="token operator">+</span>
        <span class="token string">&quot;    console.log('mounted')\n&quot;</span> <span class="token operator">+</span>
        <span class="token string">'  }\n'</span> <span class="token operator">+</span>
        <span class="token string">'}\n'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">start</span><span class="token operator">:</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token literal-property property">end</span><span class="token operator">:</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">attrs</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">map</span><span class="token operator">:</span> xxx
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">scriptSetup</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">styles</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'style'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token string">'\n.small {\n  width:21px\n}\n'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">loc</span><span class="token operator">:</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token literal-property property">attrs</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">map</span><span class="token operator">:</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">customBlocks</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>拿到 parse 之后的组件 descriptor 后 我们继续往下看</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> prevDescriptor <span class="token operator">=</span> cacheEntry <span class="token operator">&amp;&amp;</span> cacheEntry<span class="token punctuation">.</span>descriptor
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>prevDescriptor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// the file has never been accessed yet</span>
  <span class="token function">debugHmr</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">no existing descriptor found for </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>filePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre></div><p>从缓存中读取之前的组件缓存。如果没有则说明该组件还没有被渲染。什么都不用做。这里解释一下什么情况下会走到这里。当我们启动本地服务，但是并没有真正访问过该服务时。此时所有的文件缓存除了预优化的部分 都是 undefined，
这时候我们直接修改组件会走到此 if 分支。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>
  <span class="token operator">!</span><span class="token function">isEqualBlock</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">.</span>script<span class="token punctuation">,</span> prevDescriptor<span class="token punctuation">.</span>script<span class="token punctuation">)</span> <span class="token operator">||</span>
  <span class="token operator">!</span><span class="token function">isEqualBlock</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">.</span>scriptSetup<span class="token punctuation">,</span> prevDescriptor<span class="token punctuation">.</span>scriptSetup<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">sendReload</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">isEqualBlock</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">a</span><span class="token operator">:</span> SFCBlock <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token literal-property property">b</span><span class="token operator">:</span> SFCBlock <span class="token operator">|</span> <span class="token keyword">null</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 首先比较两个对象的src属性，如果一样直接返回true</span>
  <span class="token comment">// 接着遍历两个对象的 attrs 进行比较</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>a <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>b<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>a <span class="token operator">||</span> <span class="token operator">!</span>b<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span>src <span class="token operator">&amp;&amp;</span> b<span class="token punctuation">.</span>src <span class="token operator">&amp;&amp;</span> a<span class="token punctuation">.</span>src <span class="token operator">===</span> b<span class="token punctuation">.</span>src<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span>content <span class="token operator">!==</span> b<span class="token punctuation">.</span>content<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span>
  <span class="token keyword">const</span> keysA <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>attrs<span class="token punctuation">)</span>
  <span class="token keyword">const</span> keysB <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>attrs<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>keysA<span class="token punctuation">.</span>length <span class="token operator">!==</span> keysB<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> keysA<span class="token punctuation">.</span><span class="token function">every</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> a<span class="token punctuation">.</span>attrs<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">===</span> b<span class="token punctuation">.</span>attrs<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>第一种需要重新 vue-reload 的情况，当我们同一个组件前后两次渲染时的 script 或者 scriptSetup 不一致时，需要重新 load 整个组件。<a href="https://juejin.im/post/6844903877574295560" target="_blank" rel="noopener noreferrer">setup<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 是 Vue3 中新提出的特性。如果前后组件的 script* 相等，则继续往下判断。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isEqualBlock</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">.</span>template<span class="token punctuation">,</span> prevDescriptor<span class="token punctuation">.</span>template<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  needRerender <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre></div><p>接下来判断如果前后的 template 不一致，则发送 vue-rerender 消息。只需要发起 type 为 template 的请求即可。<br>
接下来是进行 style 的分析</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// css modules update causes a reload because the $style object is changed</span>
<span class="token comment">// and it may be used in JS. It also needs to trigger a vue-style-update</span>
<span class="token comment">// event so the client busts the sw cache.</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>
  prevStyles<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">s</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> s<span class="token punctuation">.</span>module <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">||</span>
  nextStyles<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">s</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> s<span class="token punctuation">.</span>module <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">sendReload</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果应用了 css-modules 的 css 文件内容更新了则需要 vue-reload。 通过注释我们也可以看出原因。因为 css-modules 导出了一个对象，并且该对象在 js 文件中可能被使用了。同时它也需要触发 vue-style-update 类型的消息去清楚之前的 service worker 的缓存的文件。
<img src="/assets/img/vuehmr.15e5ed75.png" alt="">
可以看到当我们修改 index.module.css 文件时，发送了两个消息分别是 vue-reload以及 style-update</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// force reload if CSS vars injection changed</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>
  prevStyles<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">s<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> next <span class="token operator">=</span> nextStyles<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span>attrs<span class="token punctuation">.</span>vars <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span>next <span class="token operator">||</span> next<span class="token punctuation">.</span>attrs<span class="token punctuation">.</span>vars <span class="token operator">!==</span> s<span class="token punctuation">.</span>attrs<span class="token punctuation">.</span>vars<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">sendReload</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果 inject 注入的 css 变量改变, 触发 vue-reload</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// force reload if scoped status has changed</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>prevStyles<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">s</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> s<span class="token punctuation">.</span>scoped<span class="token punctuation">)</span> <span class="token operator">!==</span> nextStyles<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">s</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> s<span class="token punctuation">.</span>scoped<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">sendReload</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果 scoped 属性发生了变化，触发 vue-reload</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// only need to update styles if not reloading, since reload forces</span>
<span class="token comment">// style updates as well.</span>
nextStyles<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>prevStyles<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">isEqualBlock</span><span class="token punctuation">(</span>prevStyles<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> nextStyles<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    didUpdateStyle <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>publicPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?type=style&amp;index=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'style-update'</span><span class="token punctuation">,</span>
      path<span class="token punctuation">,</span>
      <span class="token literal-property property">changeSrcPath</span><span class="token operator">:</span> path<span class="token punctuation">,</span>
      timestamp
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>如果组件前后的 descriptor 的 styles 属性不相等且不涉及其他会触发 vue-reload 的条件，此时发送 style-update 消息。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// stale styles always need to be removed</span>
prevStyles<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>nextStyles<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  didUpdateStyle <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'style-remove'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">path</span><span class="token operator">:</span> publicPath<span class="token punctuation">,</span>
    <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>styleId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i <span class="token operator">+</span> nextStyles<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>如果组件前后的 styles 属性长度不一致。通常是移除了整个 style 标签。此时需要发送 style-remove 消息</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> prevCustoms <span class="token operator">=</span> prevDescriptor<span class="token punctuation">.</span>customBlocks <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">const</span> nextCustoms <span class="token operator">=</span> descriptor<span class="token punctuation">.</span>customBlocks <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token comment">// custom blocks update causes a reload</span>
<span class="token comment">// because the custom block contents is changed and it may be used in JS.</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>
  nextCustoms<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
      <span class="token operator">!</span>prevCustoms<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">isEqualBlock</span><span class="token punctuation">(</span>prevCustoms<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> nextCustoms<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">sendReload</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果自定义块发生了改变则需要 vue-reload。因为自定义块在 js 中可能被使用。</p> <h3 id="客户端接收消息"><a href="#客户端接收消息" class="header-anchor">#</a> 客户端接收消息</h3> <p>上面提到了各种情况我们向客户端浏览器发送的消息类型。下面我们看看浏览器接收到这些类型的消息后分别做了什么事情</p> <h4 id="vue-reload"><a href="#vue-reload" class="header-anchor">#</a> vue-reload</h4> <p>比较简单。直接发起新的带有 t 参数的组件请求</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">case</span> <span class="token string">'vue-reload'</span><span class="token operator">:</span>
      <span class="token function">queueUpdate</span><span class="token punctuation">(</span>
        <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?t=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>timestamp<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">warnFailedFetch</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">m</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            __VUE_HMR_RUNTIME__<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> m<span class="token punctuation">.</span>default<span class="token punctuation">)</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[vite] </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> reloaded.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
      <span class="token keyword">break</span>
</code></pre></div><h4 id="vue-rerender"><a href="#vue-rerender" class="header-anchor">#</a> vue-rerender</h4> <p>如上面提到的，vue-rerender 只需要发起 type 为 template 的组件请求即可</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">case</span> <span class="token string">'vue-rerender'</span><span class="token operator">:</span>
    <span class="token keyword">const</span> templatePath <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?type=template</span><span class="token template-punctuation string">`</span></span>
    <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>templatePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;t=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>timestamp<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">m</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      __VUE_HMR_RUNTIME__<span class="token punctuation">.</span><span class="token function">rerender</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> m<span class="token punctuation">.</span>render<span class="token punctuation">)</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[vite] </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> template updated.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">break</span>
</code></pre></div><h4 id="style-remove"><a href="#style-remove" class="header-anchor">#</a> style-remove</h4> <p>style-update 在 css 热替换时已经介绍了。这里介绍 style-remove,其实本质跟 style-update 差不多。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">case</span> <span class="token string">'style-remove'</span><span class="token operator">:</span>
    <span class="token function">removeStyle</span><span class="token punctuation">(</span>payload<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
    <span class="token keyword">break</span>
<span class="token keyword">function</span> <span class="token function">removeStyle</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">id</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> style <span class="token operator">=</span> sheetsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>style<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>style <span class="token keyword">instanceof</span> <span class="token class-name">CSSStyleSheet</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// @ts-ignore</span>
      <span class="token keyword">const</span> index <span class="token operator">=</span> document<span class="token punctuation">.</span>adoptedStyleSheets<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>style<span class="token punctuation">)</span>
      <span class="token comment">// @ts-ignore</span>
      document<span class="token punctuation">.</span>adoptedStyleSheets <span class="token operator">=</span> document<span class="token punctuation">.</span>adoptedStyleSheets<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">s</span><span class="token operator">:</span> CSSStyleSheet</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> s <span class="token operator">!==</span> style
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      document<span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>style<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    sheetsMap<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过传入的文件对应的 hashid。在当前文档的 CSSStyleSheet 中移除该样式。</p> <h3 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h3> <p>综上我们可以总结出不同的消息的触发情况</p> <h4 id="vue-reload-2"><a href="#vue-reload-2" class="header-anchor">#</a> vue-reload</h4> <ul><li>script 或者 sctiptSetup 改变</li> <li>css-modules 文件改变</li> <li>css vars 改变</li> <li>scoped 改变</li> <li>customBlocks 自定义块改变</li></ul> <h4 id="vue-rerender-2"><a href="#vue-rerender-2" class="header-anchor">#</a> vue-rerender</h4> <ul><li>template 改变且不涉及其他会触发 vue-reload 的条件</li></ul> <h4 id="style-update"><a href="#style-update" class="header-anchor">#</a> style-update</h4> <ul><li>组件前后的 descriptor 的 styles 属性不相等且不涉及其他会触发 vue-reload 的条件，此时发送 style-update 消息</li></ul> <h4 id="style-remove-2"><a href="#style-remove-2" class="header-anchor">#</a> style-remove</h4> <ul><li>移除了整个 style 标签。此时需要发送 style-remove 消息</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/guide/render.html" class="prev">
        组件渲染
      </a></span> <span class="next"><a href="/guide/2.0/optimize.html">
        预优化 2.0
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.6a4c4a7b.js" defer></script><script src="/assets/js/2.52a120d4.js" defer></script><script src="/assets/js/3.ebe90f04.js" defer></script>
  </body>
</html>
